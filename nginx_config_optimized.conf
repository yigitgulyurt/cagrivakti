# HTTP -> HTTPS Yönlendirmesi (Tüm domainler için tek blok)
server {
    listen 80;
    server_name cagrivakti.com.tr api.cagrivakti.com.tr;
    
    # Certbot challenge için gerekli (SSL yenileme sırasında kullanılır)
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # Diğer tüm istekleri HTTPS'e yönlendir
    location / {
        return 301 https://$host$request_uri;
    }
}

# --------------------------------------------------
# Ana Domain (cagrivakti.com.tr) - HTTPS
# --------------------------------------------------
server {
    listen 443 ssl;
    server_name cagrivakti.com.tr;

    # SSL Sertifikaları (Certbot)
    ssl_certificate /etc/letsencrypt/live/cagrivakti.com.tr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/cagrivakti.com.tr/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Proxy Ayarları (Flask Uygulamasına Yönlendirme)
    location / {
        include proxy_params;
        proxy_pass http://unix:/var/www/cagrivakti/cagrivakti.sock;
    }

    # Statik Dosyalar (PageSpeed Optimizasyonu)
    location /static {
        alias /var/www/cagrivakti/app/static;
        
        # 1 Yıl Cache
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Vary "Accept-Encoding";
        access_log off;
    }
}

# --------------------------------------------------
# API Subdomain (api.cagrivakti.com.tr) - HTTPS
# --------------------------------------------------
server {
    listen 443 ssl;
    server_name api.cagrivakti.com.tr;

    # SSL Sertifikaları (Certbot)
    ssl_certificate /etc/letsencrypt/live/api.cagrivakti.com.tr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.cagrivakti.com.tr/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Proxy Ayarları
    location / {
        include proxy_params;
        proxy_pass http://unix:/var/www/cagrivakti/cagrivakti.sock;
    }

    # Statik Dosyalar (API üzerinden erişilirse)
    location /static {
        alias /var/www/cagrivakti/app/static;
        
        # 1 Yıl Cache
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Vary "Accept-Encoding";
        access_log off;
    }
}