{% extends "base.html" %}

{% block title %}{{ seo_title }}{% endblock %}
{% block description %}{{ seo_description }}{% endblock %}
{% block og_title %}{{ seo_title }}{% endblock %}
{% block og_description %}{{ seo_description }}{% endblock %}

{% block json_ld %}
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebPage",
      "name": "{{ seo_title }}",
      "description": "{{ seo_description }}",
      "mainEntity": {
        "@type": "Place",
        "name": "{{ get_display_name(sehir) }}",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "{{ get_display_name(sehir) }}",
          "addressCountry": "{{ country_code }}"
        }
      },
      "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [{
          "@type": "ListItem",
          "position": 1,
          "name": "Ana Sayfa",
          "item": "https://cagrivakti.com.tr"
        },{
          "@type": "ListItem",
          "position": 2,
          "name": "Şehirler",
          "item": "https://cagrivakti.com.tr/sehir"
        },{
          "@type": "ListItem",
          "position": 3,
          "name": "{{ get_display_name(sehir) }} Namaz Vakitleri",
          "item": "https://cagrivakti.com.tr{{ request.path }}"
        }]
      }
    },
    {
      "@type": "Dataset",
      "name": "{{ get_display_name(sehir) }} Namaz Vakitleri {{ current_year }}",
      "description": "{{ get_display_name(sehir) }} için {{ current_year }} yılı günlük ve aylık namaz vakitleri verisi.",
      "publisher": {
        "@type": "Organization",
        "name": "Çağrı Vakti"
      },
      "spatialCoverage": "{{ get_display_name(sehir) }}, {{ country_code }}",
      "variableMeasured": ["İmsak", "Güneş", "Öğle", "İkindi", "Akşam", "Yatsı"]
    }
  ]
}
{% endblock %}

{% block brand_text %}{{ get_display_name(sehir) }}{% endblock %}

{% block breadcrumb_json_ld %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "name": "Ana Sayfa",
    "item": "https://cagrivakti.com.tr"
  },{
    "@type": "ListItem",
    "position": 2,
    "name": "{{ get_display_name(sehir) }}",
    "item": "https://cagrivakti.com.tr/sehir/{{ sehir }}"
  }]
}
</script>
{% endblock %}

{% block content %}
<div class="container fade-in">
    <!-- Breadcrumb -->
    <nav aria-label="Breadcrumb" class="breadcrumb-nav">
        <ol class="breadcrumb-list">
            <li class="breadcrumb-item"><a href="{{ url_for('views.index') }}">Ana Sayfa</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('views.sehir_secimi') }}">Şehirler</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ get_display_name(sehir) }}</li>
        </ol>
    </nav>

    <header class="header">
        <h1>{{ get_display_name(sehir) }}</h1>
        <div class="header-buttons">
            <a href="{{ url_for('views.index') }}" class="btn btn-secondary" title="Ana Sayfaya Dön">
                <!-- SVG İkonu: Ev -->
                <svg class="icon" aria-hidden="true"><use xlink:href="#fa-home"></use></svg>
                <span>Ana Sayfa</span>
            </a>
            <a href="{{ url_for('views.sehir_secimi') }}" class="btn btn-primary" title="Başka Bir Şehir Seç">
                <!-- SVG İkonu: Konum İşareti -->
                <svg class="icon" aria-hidden="true"><use xlink:href="#fa-map-marker-alt"></use></svg>
                <span>İl Değiştir</span>
            </a>
        </div>
    </header>

    {% if ramadan_info.is_laylat_al_qadr %}
    <div class="qadr-night-alert fade-in">
        <div class="qadr-icon">
            <svg class="icon" aria-hidden="true"><use xlink:href="#fa-star-and-crescent"></use></svg>
        </div>
        <div class="qadr-text">
            <h3>Kadir Geceniz Kutlu Olsun</h3>
            <p>Bu gece, bin aydan daha yararlı olan Kadir Gecesi'dir. Bu kutlu geceyi dua, yakarış ve tövbe ile yerine getirmeniz salık verilir.</p>
        </div>
    </div>
    {% endif %}

    <section class="daily-content-card" id="daily-content" title="Günün Dini İçeriği">
        {% if ramadan_info.is_ramadan %}
        <div class="daily-icon">
            <svg class="icon" aria-hidden="true"><use xlink:href="#fa-moon"></use></svg>
        </div>
        <div class="daily-text">
            <span class="daily-label">Günün Ramazan İletisi</span>
            <p id="ramadan-message">{{ ramadan_info.ramadan_content }}</p>
        </div>
        {% elif daily_content %}
        <div class="daily-type">{{ daily_content.type }}</div>
        <div class="daily-text">{{ daily_content.text }}</div>
        <div class="daily-source">{{ daily_content.source }}</div>
        {% else %}
        <div class="skeleton skeleton-text" style="width: 20%; margin-bottom: 15px;"></div>
        <div class="skeleton skeleton-text" style="width: 100%; height: 2rem; margin-bottom: 15px;"></div>
        <div class="skeleton skeleton-text" style="width: 40%;"></div>
        {% endif %}
    </section>

    <main class="vakitler-container">
        <div class="vakitler-grid">
            {% set vakit_list = [
                ('imsak', 'İmsak'),
                ('gunes', 'Güneş'),
                ('ogle', 'Öğle'),
                ('ikindi', 'İkindi'),
                ('aksam', 'İftar' if ramadan_info.is_ramadan else 'Akşam'),
                ('yatsi', 'Teravih' if ramadan_info.is_ramadan else 'Yatsı')
            ] %}
            
            {% for id, label in vakit_list %}
            <div class="vakit-card {% if vakitler[id] == '--:--' %}skeleton-card{% endif %}" id="card-{{ id }}">
                <h2>{{ label }}</h2>
                <span class="vakit-time" id="{{ id }}">
                    {% if vakitler[id] == '--:--' %}
                    <div class="skeleton skeleton-title" style="width: 80%; height: 3rem; margin: 0 auto;"></div>
                    {% else %}
                    {{ vakitler[id] }}
                    {% endif %}
                </span>
                <div class="vakit-countdown" id="{{ id }}-countdown">
                    {% if vakitler[id] == '--:--' %}
                    <div class="skeleton skeleton-text" style="width: 60%; margin: 0 auto;"></div>
                    {% else %}
                    --:--:--
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <div class="prayer-warning-footer fade-in">
        <svg class="icon" aria-hidden="true"><use xlink:href="#fa-circle-info"></use></svg>
        <span><strong>Uyarı:</strong> Vakitler konuma göre birkaç dakika değişebilir, önlemli olmak adına ezan sesini ya da yerel duyuruları izleyiniz.</span>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding: 25px;
    background-color: var(--card-bg);
    border-radius: 20px;
    box-shadow: var(--card-shadow);
    gap: 20px; /* Added gap */
    flex-wrap: wrap; /* Allow wrapping for very long names/many buttons */
}

.header h1 {
    font-size: 2.2em;
    color: var(--primary);
    font-weight: 800;
    margin: 0;
    flex: 1; /* Allow h1 to take available space */
    min-width: 200px; /* Minimum width before wrapping */
}

.header-buttons {
    display: flex;
    gap: 12px;
    flex-shrink: 0; /* Prevent buttons from shrinking */
    flex-wrap: wrap; /* Allow buttons to wrap if they don't fit */
}

/* Uyarı Yazısı (Alt) */
.prayer-warning-footer {
    margin-top: 40px;
    padding: 20px;
    text-align: center;
    color: var(--gray);
    font-size: 0.85rem;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    opacity: 0.7;
}

.prayer-warning-footer strong {
    color: var(--primary);
    font-weight: 600;
}

.prayer-warning-footer .icon {
    font-size: 1rem;
    color: var(--primary);
}

/* Kadir Gecesi Uyarısı */
.qadr-night-alert {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    color: white;
    box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
}

.qadr-icon {
    font-size: 2.5rem;
    background: rgba(255, 255, 255, 0.2);
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
}

.qadr-text h3 {
    margin: 0 0 5px 0;
    font-size: 1.4rem;
    font-weight: 700;
}

.qadr-text p {
    margin: 0;
    font-size: 1rem;
    opacity: 0.9;
    line-height: 1.4;
}

/* Günlük İçerik Kartı */
.daily-content-card {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 25px;
    border-radius: 20px;
    margin-bottom: 30px;
    box-shadow: var(--card-shadow);
    position: relative;
    overflow: hidden;
}

.daily-content-card::after {
    position: absolute;
    right: -10px;
    bottom: -10px;
    font-size: 8rem;
    opacity: 0.1;
    transform: rotate(-15deg);
}

.daily-type {
    font-size: 0.85rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--primary);
    margin-bottom: 10px;
}

.daily-text {
    font-size: 1.25rem;
    line-height: 1.6;
    margin-bottom: 15px;
    font-family: 'Amiri', serif;
}

.daily-source {
    font-size: 0.9rem;
    opacity: 0.8;
    font-style: italic;
}

/* Vakitler */
.vakitler-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.vakit-card {
    background-color: var(--card-bg);
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    transition: var(--transition);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.vakit-card:hover {
    transform: translateY(-5px);
    background-color: var(--hover-color);
    border-color: var(--primary);
}

.skeleton-card {
    cursor: default;
    pointer-events: none;
}

.vakit-card h2 {
    color: var(--primary);
    font-size: 1.4rem;
    margin-bottom: 15px;
    font-weight: 600;
}

.vakit-time {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--text);
    display: block;
    margin-bottom: 15px;
}

.vakit-countdown {
    background-color: rgba(255, 193, 7, 0.1);
    color: var(--primary);
    padding: 10px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1.2rem;
    font-family: monospace;
}

@media (max-width: 768px) {
    .container { padding: 10px; }
    .header { 
        padding: 15px; 
        flex-direction: row; /* Yan yana kalsın */
        flex-wrap: wrap; /* Sığmazsa alt satıra geçsin */
        justify-content: space-between;
        gap: 10px; 
        margin-bottom: 15px;
    }
    .header h1 { 
        font-size: 1.5rem; 
        margin: 0; 
        min-width: auto; 
        width: auto; 
        flex: 1;
    }
    .header-buttons { 
        width: auto; 
        display: flex; 
        gap: 8px; 
    }
    .header-buttons .btn { 
        justify-content: center; 
        width: auto; 
        padding: 8px 12px; 
        font-size: 0.85rem; 
        height: 36px;
    }
    .header-buttons .btn span { display: none; } /* Mobilde metni gizle */
    .header-buttons .btn svg { margin: 0; font-size: 1.1rem; }
    
    .qadr-night-alert { padding: 15px; flex-direction: row; text-align: left; gap: 15px; margin-bottom: 15px; }
    .qadr-icon { width: 50px; height: 50px; font-size: 1.5rem; }
    .qadr-text h3 { font-size: 1.1rem; }
    .qadr-text p { font-size: 0.85rem; }

    .daily-content-card { padding: 15px; margin-bottom: 15px; border-radius: 16px; }
    .daily-text { font-size: 1rem; line-height: 1.4; margin-bottom: 10px; }
    .daily-type { font-size: 0.7rem; margin-bottom: 5px; }
    
    .vakitler-grid { 
        grid-template-columns: repeat(3, 1fr); /* 3 kolonlu yapı */
        gap: 8px; 
    }
    .vakit-card { 
        padding: 10px 5px; 
        border-radius: 12px; 
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 90px;
    }
    .vakit-card h2 { 
        font-size: 0.85rem; 
        margin-bottom: 4px; 
        font-weight: 500;
        opacity: 0.9;
    }
    .vakit-time { 
        font-size: 1.3rem; 
        margin-bottom: 4px; 
        font-weight: 700;
    }
    .vakit-countdown { 
        font-size: 0.75rem; 
        padding: 4px 6px; 
        border-radius: 6px; 
        background: transparent;
        color: var(--text);
        opacity: 0.7;
        margin-top: auto;
    }

    .prayer-warning-footer { padding: 10px; font-size: 0.7rem; margin-top: 15px; }
}

@media (max-width: 480px) {
    .vakitler-grid { 
        grid-template-columns: repeat(2, 1fr); /* Çok küçük ekranlarda 2 kolon */
        gap: 8px;
    }
    .vakit-card { padding: 12px 8px; min-height: auto; }
    .vakit-time { font-size: 1.5rem; }
    .header h1 { font-size: 1.3rem; }
}

@keyframes navbar-pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
        transform: scale(1);
        border-color: rgba(255, 193, 7, 0.4);
    }
    50% {
        box-shadow: 0 0 15px 2px rgba(255, 193, 7, 0.6);
        transform: scale(1.05);
        border-color: rgba(255, 193, 7, 0.8);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
        transform: scale(1);
        border-color: rgba(255, 193, 7, 0.4);
    }
}
</style>
{% endblock %}

{% block footer_js %}
<script>
    let mevcutSehir = "{{ sehir }}";
    let mevcutUlke = "{{ country_code }}";
    let namazVakitleri = JSON.parse('{{ vakitler|tojson|safe }}');

    // LocalStorage Önbellek Yönetimi
    // Versiyon kontrolü: Eski cache'leri temizlemek için suffix ekledik
    const CACHE_VERSION = 'v2';
    const CACHE_KEY = `vakitler_${mevcutSehir}_${mevcutUlke}_${CACHE_VERSION}`;
    const DAILY_CONTENT_CACHE_KEY = `daily_content_cache_${CACHE_VERSION}`;

    // Eski cache'leri temizle (v1 veya versiyonsuz)
    try {
        const oldKey = `vakitler_${mevcutSehir}_${mevcutUlke}`;
        if (localStorage.getItem(oldKey)) {
            localStorage.removeItem(oldKey);
        }
        if (localStorage.getItem('daily_content_cache')) {
            localStorage.removeItem('daily_content_cache');
        }
    } catch (e) { console.error('Eski cache temizleme hatası:', e); }
    
    
    // TODAY hesaplaması: Şehrin yerel saatine göre yapılmalı
    const _now = new Date();
    const _tz = namazVakitleri.timezone || 'Europe/Istanbul';
    const _cityNowStr = _now.toLocaleString("en-US", {timeZone: _tz});
    const _cityNow = new Date(_cityNowStr);
    const _year = _cityNow.getFullYear();
    const _month = String(_cityNow.getMonth() + 1).padStart(2, '0');
    const _day = String(_cityNow.getDate()).padStart(2, '0');
    const TODAY = `${_year}-${_month}-${_day}`;

    function getCachedVakitler() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const parsed = JSON.parse(cached);
                // Sadece bugüne ait veriyi kullan
                if (parsed.tarih === TODAY) {
                    return parsed.data;
                }
            }
        } catch (e) { console.error('Cache okuma hatası:', e); }
        return null;
    }

    function setCachedVakitler(data) {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify({
                tarih: TODAY,
                data: data
            }));
        } catch (e) { console.error('Cache yazma hatası:', e); }
    }

    function getCachedDailyContent() {
        try {
            const cached = localStorage.getItem(DAILY_CONTENT_CACHE_KEY);
            if (cached) {
                const parsed = JSON.parse(cached);
                if (parsed.tarih === TODAY) {
                    return parsed.data;
                }
            }
        } catch (e) { console.error('Daily content cache okuma hatası:', e); }
        return null;
    }

    function setCachedDailyContent(data) {
        try {
            localStorage.setItem(DAILY_CONTENT_CACHE_KEY, JSON.stringify({
                tarih: TODAY,
                data: data
            }));
        } catch (e) { console.error('Daily content cache yazma hatası:', e); }
    }

    function renderVakitler(vakitlerData) {
        ['imsak', 'gunes', 'ogle', 'ikindi', 'aksam', 'yatsi'].forEach(v => {
            const el = document.getElementById(v);
            const card = document.getElementById(`card-${v}`);
            const countdownEl = document.getElementById(`${v}-countdown`);
            
            if (el && vakitlerData[v]) {
                el.textContent = vakitlerData[v];
                card.classList.remove('skeleton-card');
                
                if (el.querySelector('.skeleton')) {
                    el.innerHTML = vakitlerData[v];
                }
                if (countdownEl && countdownEl.querySelector('.skeleton')) {
                    countdownEl.innerHTML = '--:--:--';
                }
            }
        });
    }

    async function namazVakitleriniYukle() {
        // 1. Önce cache'e bak
        const cached = getCachedVakitler();
        if (cached) {
            namazVakitleri = cached;
            renderVakitler(namazVakitleri);
            updateCountdowns();
            return; // Önbellek varsa API'ye gitme
        }

        try {
            const response = await fetch(`https://api.cagrivakti.com.tr/namaz_vakitleri?sehir=${mevcutSehir}&country=${mevcutUlke}`);
            const data = await response.json();
            
            if (data.vakitler) {
                // Timezone bilgisini namazVakitleri objesine ekle
                namazVakitleri = {
                    ...data.vakitler,
                    timezone: data.timezone || 'Europe/Istanbul',
                    yarin: data.yarin || null,
                    is_ramadan: (typeof namazVakitleri.is_ramadan !== 'undefined') ? namazVakitleri.is_ramadan : false
                };
                
                setCachedVakitler(namazVakitleri);
                renderVakitler(namazVakitleri);
                
                updateCountdowns();
            }
        } catch (error) {
            console.error('Namaz vakitleri yüklenemedi:', error);
        }
    }

    function updateCountdowns() {
        if (!namazVakitleri) return;

        const tz = namazVakitleri.timezone || 'Europe/Istanbul';
        
        // Yerel saati ve şehir saatini al
        const now = new Date();
        const cityNowStr = now.toLocaleString("en-US", {timeZone: tz});
        const cityNow = new Date(cityNowStr);
        
        // Navbar için değişkenler
        let nextVakitName = null;
        let nextVakitTime = null;
        let minDiff = Infinity;
        
        // Milisaniye cinsinden farkı hesapla (toLocaleString saniyeyi yuvarlayabilir, daha hassas fark için)
        // Ancak geri sayım için cityNow yeterlidir.
        
        ['imsak', 'gunes', 'ogle', 'ikindi', 'aksam', 'yatsi'].forEach(vakit => {
            const saat = namazVakitleri[vakit];
            if (!saat || saat === "--:--" || saat.includes('skeleton')) return;
            
            const [hours, minutes] = saat.split(":").map(Number);
            const vakitDate = new Date(cityNow);
            vakitDate.setHours(hours, minutes, 0, 0);
            
            // Navbar için en yakın gelecek vakti bul
            const diffForNavbar = vakitDate - cityNow;
            if (diffForNavbar > 0 && diffForNavbar < minDiff) {
                minDiff = diffForNavbar;
                nextVakitName = vakit;
                nextVakitTime = saat;
            }
            
            const countdownEl = document.getElementById(`${vakit}-countdown`);
            if (!countdownEl) return;

            // Eğer vakit geçtiyse bir sonraki günün vaktini mi hesaplamalıyız? 
            // Şimdilik sadece "Vakit geçti" veya "Vakit geldi" gösteriyoruz.
            if (vakitDate < cityNow) {
                const diffMinutes = (cityNow - vakitDate) / 60000;
                if (diffMinutes >= 0 && diffMinutes < 45) {
                    countdownEl.textContent = 'Vakit geldi';
                    countdownEl.style.color = '#10b981';
                    countdownEl.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                } else {
                    countdownEl.textContent = 'Vakit geçti';
                    countdownEl.style.color = '';
                    countdownEl.style.backgroundColor = '';
                }
                return;
            }
            
            const timeDiff = vakitDate - cityNow;
            const h = Math.floor(timeDiff / 3600000);
            const m = Math.floor((timeDiff % 3600000) / 60000);
            const s = Math.floor((timeDiff % 60000) / 1000);
            
            countdownEl.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            countdownEl.style.color = '';
            countdownEl.style.backgroundColor = '';
        });

        // Eğer tüm vakitler geçtiyse (Yatsı sonrası), sonraki vakit yarın İmsak'tır
        if (minDiff === Infinity) {
            // Yatsı vakti geçtikten sonra İmsak kartını güncelle
            const imsakEl = document.getElementById('imsak');
            const imsakCountdownEl = document.getElementById('imsak-countdown');
            
            if (namazVakitleri.yarin && namazVakitleri.yarin.imsak) {
                const nextImsakTime = namazVakitleri.yarin.imsak;
                const [hours, minutes] = nextImsakTime.split(":").map(Number);
                
                const vakitDate = new Date(cityNow);
                // Eğer saat 23:59 ise yarınki imsak için 1 gün ekle
                // Eğer gece yarısı (00:01) ise zaten gün değiştiği için bugünün imsak'ı olacak
                // ANCAK: Gece yarısı geçince namazVakitleri yenilenmediyse hala dünün verisi var demektir.
                // Bu durumda hala dünün tarihi + 1 gün yapmalıyız.
                // Basit mantık: Yatsı'dan sonra her zaman bir sonraki İmsak hedeflenir.
                // Yatsı saati < Şu an < Gece Yarısı: Tarih = Yarın
                // Gece Yarısı < Şu an < İmsak: Tarih = Bugün
                
                // Yatsı saatini kontrol et
                const yatsiSaat = namazVakitleri['yatsi'];
                const [yH, yM] = yatsiSaat.split(":").map(Number);
                const yatsiDate = new Date(cityNow);
                yatsiDate.setHours(yH, yM, 0, 0);
                
                if (cityNow > yatsiDate) {
                     // Gece yarısı kontrolü (00:00 - İmsak arası mı?)
                     // Eğer cityNow saat 00:00 ile İmsak arası ise, gün zaten değişmiştir.
                     // Ancak namazVakitleri objesi eski (dünün) verisi olabilir.
                     // Eğer namazVakitleri.tarih != cityNow.toISOString().split('T')[0] ise veri eskidir.
                     
                     // Basit çözüm: Yatsı geçtikten sonra hedef her zaman YARINKİ imsak saatidir.
                     // Eğer saat 23:00 ise (Yatsı 20:00), hedef Yarın 05:00
                     // Eğer saat 01:00 ise (Yatsı dün 20:00), hedef Bugün 05:00
                     
                     // Bu karmaşayı çözmek için:
                     // 1. namazVakitleri.yarin.imsak'ı al.
                     // 2. Bu saati bugünün tarihiyle oluştur.
                     // 3. Eğer oluşan tarih < cityNow ise (yani saat 01:00, imsak 05:00 ise tarih > cityNow olur, sorun yok. Ama saat 06:00 ise tarih < cityNow olur)
                     // Durum: Yatsı sonrası (23:00). İmsak 05:00. Hedef: Yarın 05:00.
                     // Durum: Gece yarısı sonrası (01:00). İmsak 05:00. Hedef: Bugün 05:00.
                     
                     let targetDate = new Date(cityNow);
                     targetDate.setHours(hours, minutes, 0, 0);
                     
                     if (targetDate < cityNow) {
                         targetDate.setDate(targetDate.getDate() + 1);
                     }
                     
                     minDiff = targetDate - cityNow;
                     nextVakitName = 'imsak';
                     nextVakitTime = nextImsakTime;
                     
                     // İmsak Kartını Güncelle (Sadece Yatsı geçtikten sonra)
                     if (imsakEl) imsakEl.textContent = nextImsakTime;
                     
                     // İmsak Geri Sayımını Güncelle
                     if (imsakCountdownEl) {
                        const h = Math.floor(minDiff / 3600000);
                        const m = Math.floor((minDiff % 3600000) / 60000);
                        const s = Math.floor((minDiff % 60000) / 1000);
                        imsakCountdownEl.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                        imsakCountdownEl.style.color = '';
                        imsakCountdownEl.style.backgroundColor = '';
                     }
                }
            } else if (namazVakitleri['imsak']) {
                // Fallback (Yarın verisi yoksa eski mantık)
                const saat = namazVakitleri['imsak'];
                const [hours, minutes] = saat.split(":").map(Number);
                
                const vakitDate = new Date(cityNow);
                vakitDate.setDate(vakitDate.getDate() + 1);
                vakitDate.setHours(hours, minutes, 0, 0);
                
                minDiff = vakitDate - cityNow;
                nextVakitName = 'imsak';
                nextVakitTime = saat;
            }
        }

        // Gün değişimi kontrolü (Gece yarısı tetikleyicisi)
        const currentDataDate = namazVakitleri.tarih; // API'den gelen tarih (YYYY-MM-DD)
        
        // cityNow objesi hedef şehrin saatini "yerel saat" gibi tutuyor.
        // Bu yüzden toISOString() yerine doğrudan get metodlarını kullanmalıyız.
        // Çünkü toISOString() UTC'ye çevirir ve timezone farkından dolayı tarihi geri atabilir.
        const year = cityNow.getFullYear();
        const month = String(cityNow.getMonth() + 1).padStart(2, '0');
        const day = String(cityNow.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;
        
        // Eğer verideki tarih bugünün tarihi değilse ve saat 00:00'ı geçtiyse yenile
        // Not: Yatsı sonrası İmsak sayacı bozulmasın diye sadece tarih değişince yenileme yapıyoruz.
        // Ancak kullanıcı "10 Şubat gece yarısına geldikten sonra imsak vakti hala 11 şubatta kalsın" dedi.
        // Bu yüzden gece yarısı olsa bile hemen yenilemek yerine, belki de bir süre beklemeli miyiz?
        // Hayır, yenilenince zaten yeni günün İmsak verisi gelecek (ki o da aynı saat).
        // Tek fark: İmsak kartında "Yarın" yerine "Bugün" yazacak gibi düşünebiliriz ama UI'da tarih yazmıyor, sadece saat yazıyor.
        // Dolayısıyla yenilemekte sorun yok.
        
        if (currentDataDate && currentDataDate !== todayStr) {
            console.log("Gün değişti, veriler yenileniyor...");
            namazVakitleriniYukle(); // Bu asenkron çalışır, bir sonraki intervalda güncel veriler gelir.
        }

        // Navbar Güncelleme
        const navEl = document.getElementById('navbar-vakit-countdown');
        if (navEl && nextVakitName) {
            const h = Math.floor(minDiff / 3600000);
            const m = Math.floor((minDiff % 3600000) / 60000);
            const s = Math.floor((minDiff % 60000) / 1000);
            
            const map = {'imsak': 'İmsak', 'gunes': 'Güneş', 'ogle': 'Öğle', 'ikindi': 'İkindi', 'aksam': 'Akşam', 'yatsi': 'Yatsı'};
            const displayName = map[nextVakitName] || nextVakitName;
            
            navEl.style.display = 'flex';
            navEl.style.alignItems = 'center';
            navEl.style.gap = '8px';
            
            // Mobil uyumluluk için font ayarı
            if (window.innerWidth < 768) {
                navEl.style.fontSize = '0.8rem';
                navEl.style.marginLeft = '10px';
            } else {
                navEl.style.fontSize = '0.9rem';
            }
            
            navEl.innerHTML = `
                <div style="display: flex; flex-direction: column; line-height: 1; text-align: right; justify-content: center;">
                    <span style="font-size: 1em; opacity: 1; font-weight: 700; color: #ffc107;">${displayName}</span>
                    <span style="font-weight: 800; color: #fff; font-size: 1.1em;">${nextVakitTime}</span>
                </div>
                <div style="background: rgba(255, 193, 7, 0.15); color: #ffc107; padding: 0px 8px; border-radius: 6px; font-family: 'Courier New', monospace; font-weight: 800; font-size: 1.3em; line-height: 1.2; letter-spacing: 0.5px; border: 1px solid rgba(255, 193, 7, 0.4); animation: navbar-pulse 1s infinite ease-in-out; margin: 0 5px;">
                    ${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}
                </div>
                <span style="font-size: 1em; opacity: 0.9; align-self: center; font-weight: 600; color: #ffc107;">kaldı</span>
            `;
        }
    }

    function renderDailyContent(data) {
        const dailyCard = document.getElementById('daily-content');
        if (dailyCard && data && data.text) {
            let contentHtml = '';
            if (namazVakitleri.is_ramadan) {
                contentHtml = `
                    <div class="daily-icon">
                        <svg class="icon"><use xlink:href="#fa-moon"></use></svg>
                    </div>
                    <div class="daily-text">
                        <span class="daily-label">Günün Ramazan İletisi</span>
                        <p id="ramadan-message">${data.text}</p>
                    </div>`;
            } else {
                contentHtml = `
                    <div class="daily-type">${data.type || 'Günün Sözü'}</div>
                    <div class="daily-text">${data.text}</div>
                    <div class="daily-source">${data.source || ''}</div>`;
            }
            dailyCard.innerHTML = contentHtml;
        }
    }

    async function dailyContentYukle() {
        // 1. Önce cache'e bak
        const cached = getCachedDailyContent();
        if (cached) {
            renderDailyContent(cached);
            return;
        }

        try {
            const response = await fetch('https://api.cagrivakti.com.tr/daily_content');
            const data = await response.json();
            
            if (data && data.text) {
                setCachedDailyContent(data);
                renderDailyContent(data);
            }
        } catch (error) {
            console.error('Daily content yüklenemedi:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', async function() {
        await namazVakitleriniYukle();
        await dailyContentYukle();
        updateCountdowns();
        setInterval(updateCountdowns, 1000);
        // Sayfa açıkken 30 dakikada bir kontrol et (eskiden 1 dakikaydı)
        setInterval(() => {
            const cached = getCachedVakitler();
            if (!cached) namazVakitleriniYukle();
        }, 1800000);
    });
</script>
{% endblock %}