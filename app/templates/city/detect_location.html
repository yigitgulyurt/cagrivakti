{% extends "base.html" %}

{% block title %}Konum Bulunuyor | Çağrı Vakti{% endblock %}

{% block content %}
<div class="location-wrapper fade-in" data-city-url="{{ url_for('views.sehir_sayfasi', sehir='PLACEHOLDER') }}">
    <div class="container">
        <div class="location-card">
            <div id="status-icon" class="status-icon">
                <svg class="icon fa-spin"><use xlink:href="#fa-spinner"></use></svg>
            </div>
            <h1 id="status-title">Konumunuz Alınıyor</h1>
            <p id="status-text">Size en yakın şehri bulmak için cihazınızın konum bilgisi kullanılıyor...</p>
            
            <div id="error-actions" class="error-actions" style="display: none;">
                <a href="{{ url_for('views.sehir_secimi') }}" id="manual-select-btn" class="btn btn-primary">Elle Şehir Seç</a>
                <button onclick="getLocation()" class="btn btn-secondary">Tekrar Dene</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.location-wrapper {
    min-height: calc(100vh - 70px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.location-card {
    background: var(--card-bg);
    padding: 60px 40px;
    border-radius: 32px;
    text-align: center;
    max-width: 500px;
    width: 100%;
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

.status-icon {
    font-size: 4rem;
    color: var(--primary);
    margin-bottom: 24px;
}

.location-card h1 {
    font-size: 1.8rem;
    margin-bottom: 16px;
    color: var(--text);
}

.location-card p {
    color: var(--gray);
    margin-bottom: 32px;
}

.error-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.error-actions .btn {
    width: 100%;
    justify-content: center;
}

@media (max-width: 480px) {
    .location-card {
        padding: 40px 20px;
    }
    .location-card h1 {
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const CITY_DISPLAY_MAPPING = {{ CITY_DISPLAY_NAME_MAPPING | tojson | safe if CITY_DISPLAY_NAME_MAPPING else '{}' }};
// Reverse mapping for normalization
const REVERSE_CITY_MAPPING = Object.fromEntries(
    Object.entries(CITY_DISPLAY_MAPPING).map(([latin, turkish]) => [turkish, latin])
);

function getLatinName(turkishName) {
     // 1. Direct reverse mapping check
     if (REVERSE_CITY_MAPPING[turkishName]) {
         return REVERSE_CITY_MAPPING[turkishName];
     }

     // 2. Generic normalization for other Turkish characters
     const charMap = {
         'ç': 'c', 'Ç': 'C',
         'ğ': 'g', 'Ğ': 'G',
         'ı': 'i', 'İ': 'I',
         'ö': 'o', 'Ö': 'O',
         'ş': 's', 'Ş': 'S',
         'ü': 'u', 'Ü': 'U'
     };
     
     let normalized = turkishName.split('').map(char => charMap[char] || char).join('');
     
     // URL safe format: space to dash, remove non-latin
     return normalized.replace(/\s+/g, '-').replace(/[^A-Za-z0-9\-]/g, '');
 }

 function getDisplayName(latinName) {
     return CITY_DISPLAY_MAPPING[latinName] || latinName;
 }

 function getLocation() {
    const statusIcon = document.getElementById('status-icon');
    const statusTitle = document.getElementById('status-title');
    const statusText = document.getElementById('status-text');
    const errorActions = document.getElementById('error-actions');
    const manualSelectBtn = document.getElementById('manual-select-btn');

    // URL parametrelerini kontrol et
    const urlParams = new URLSearchParams(window.location.search);
    const source = urlParams.get('source');

    // Eğer PWA kurulumu için geldiysek, elle seçim butonuna parametre ekle
    if (source === 'pwa_install' && manualSelectBtn) {
        const currentHref = manualSelectBtn.getAttribute('href');
        if (currentHref && !currentHref.includes('source=')) {
            const separator = currentHref.includes('?') ? '&' : '?';
            manualSelectBtn.setAttribute('href', `${currentHref}${separator}source=pwa_install`);
        }
    }

    // Önce LocalStorage kontrolü yap
    const cityUrlPattern = document.querySelector('.location-wrapper').dataset.cityUrl;
    const savedCity = localStorage.getItem('user_city');
    if (savedCity) {
        statusIcon.innerHTML = '<svg class="icon"><use xlink:href="#fa-check-circle"></use></svg>';
        statusTitle.textContent = "Kayıtlı Şehir Yükleniyor";
        statusText.textContent = `${getDisplayName(savedCity)} için yönlendiriliyorsunuz...`;
        
        setTimeout(() => {
            let redirectUrl = cityUrlPattern.replace('PLACEHOLDER', savedCity);
            if (source === 'pwa_install') {
                const separator = redirectUrl.includes('?') ? '&' : '?';
                redirectUrl += `${separator}source=pwa_install`;
            }
            window.location.href = redirectUrl;
        }, 800);
        return;
    }

    statusIcon.innerHTML = '<svg class="icon fa-spin"><use xlink:href="#fa-spinner"></use></svg>';
    statusTitle.textContent = "Konumunuz Alınıyor";
    statusText.textContent = "Size en yakın şehri bulmak için cihazınızın konum bilgisi kullanılıyor...";
    errorActions.style.display = 'none';

    if (!navigator.geolocation) {
        showError("Tarayıcınız konum özelliğini desteklemiyor.");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            statusTitle.textContent = "Şehir Belirleniyor";
            statusText.textContent = "Koordinatlar başarıyla alındı, şehir ismi sorgulanıyor...";

            try {
                // Nominatim Reverse Geocoding
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=tr`);
                const data = await response.json();
                
                if (data && data.address) {
                    // Şehir ismini ayıkla (province, city, town, state)
                    let originalCityName = data.address.province || data.address.city || data.address.town || data.address.state;
                    
                    if (originalCityName) {
                        originalCityName = originalCityName.replace(" İli", "").replace(" Province", "").trim();
                        const latinCityName = getLatinName(originalCityName);
                        
                        // LocalStorage'a Latin halini kaydet
                        localStorage.setItem('user_city', latinCityName);
                        
                        // Cookie'ye de kaydet (PWA shortcut için)
                        document.cookie = `user_city=${latinCityName}; path=/; max-age=31536000; SameSite=Lax`;
                        
                        statusIcon.innerHTML = '<svg class="icon"><use xlink:href="#fa-check-circle"></use></svg>';
                        statusTitle.textContent = "Şehir Bulundu!";
                        statusText.textContent = `${originalCityName} olarak kaydedildi ve yönlendiriliyorsunuz...`;
                        
                        setTimeout(() => {
                            let redirectUrl = cityUrlPattern.replace('PLACEHOLDER', latinCityName);
                            if (source === 'pwa_install') {
                                const separator = redirectUrl.includes('?') ? '&' : '?';
                                redirectUrl += `${separator}source=pwa_install`;
                            }
                            window.location.href = redirectUrl;
                        }, 1000);
                    } else {
                        showError("Konumunuzdan şehir bilgisi alınamadı.");
                    }
                } else {
                    showError("Şehir bilgisi sorgulanamadı.");
                }
            } catch (err) {
                console.error("Reverse geocoding error:", err);
                showError("Şehir bilgisi alınırken bir hata oluştu.");
            }
        },
        (error) => {
            console.error("Geolocation error:", error);
            let msg = "Konum izni reddedildi veya konum alınamadı.";
            if (error.code === error.PERMISSION_DENIED) {
                msg = "Konum izni verilmedi. Lütfen tarayıcı ayarlarından izin verin.";
            } else if (error.code === error.TIMEOUT) {
                msg = "Konum alma işlemi zaman aşımına uğradı. Lütfen tekrar deneyin.";
            }
            showError(msg);
        },
        { 
            timeout: 30000,     // 30 saniye bekle (önceki 10s az geliyordu)
            maximumAge: 300000, // 5 dakikalık eski konumu kabul et (hız için)
            enableHighAccuracy: false // GPS yerine WiFi/Baz istasyonu kullan (daha hızlı)
        }
    );
}

function showError(message) {
    const statusIcon = document.getElementById('status-icon');
    const statusTitle = document.getElementById('status-title');
    const statusText = document.getElementById('status-text');
    const errorActions = document.getElementById('error-actions');

    statusIcon.innerHTML = '<svg class="icon" style="color: #ef4444;"><use xlink:href="#fa-exclamation-circle"></use></svg>';
    statusTitle.textContent = "Hata Oluştu";
    statusText.textContent = message;
    errorActions.style.display = 'flex';
}

// Sayfa yüklendiğinde otomatik başlat
document.addEventListener('DOMContentLoaded', getLocation);
</script>
{% endblock %}
