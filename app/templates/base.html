<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>{% block title %}Çağrı Vakti | Çağdaş, Hızlı ve Doğru{% endblock %}</title>

    <!-- SEO Meta Etiketleri -->
    <meta name="description" content="{% block description %}Dünya genelinde çağrı vakitleri, imsakiye ve dini içerikler. Çağdaş arayüz ve doğru verilerle yanınızdayız.{% endblock %}">
    <meta name="keywords" content="{% block keywords %}ramazan, imsakiye, çağrı vakitleri, iftar, sahur, ezan vakitleri, namaz saatleri{% endblock %}">
    <meta name="author" content="Çağrı Vakti">
    <link rel="canonical" href="{% block canonical %}https://cagrivakti.com.tr{{ request.path }}{% endblock %}">

    <!-- Open Graph Meta Etiketleri -->
    <meta property="og:title" content="{% block og_title %}Çağrı Vakti{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Günlük çağrı vakitleri ve Ramazan'a özel içerikler{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cagrivakti.com.tr{{ request.path }}">
    <meta property="og:image" content="https://cagrivakti.com.tr/static/icons/og-image.webp">
    <meta property="og:image:alt" content="Çağrı Vakti Namaz Vakitleri Logosu ve Tasarımı">

    <!-- Twitter Card Meta Etiketleri -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{{ self.og_title() }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ self.og_description() }}{% endblock %}">
    <meta name="twitter:image" content="https://cagrivakti.com.tr/static/icons/og-image.webp">
    <meta name="twitter:image:alt" content="Çağrı Vakti Namaz Vakitleri Sosyal Medya Paylaşım Görseli">

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {% block json_ld %}
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Çağrı Vakti",
      "url": "https://cagrivakti.com.tr",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://cagrivakti.com.tr/sehir/{search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    {% endblock %}
    
    {% block breadcrumb_json_ld %}{% endblock %}
    </script>

    <!-- Favicon ve App Icons -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icons/favicon.ico') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/ios/180.png') }}">
    <link rel="mask-icon" href="{{ url_for('static', filename='icons/android/android-launchericon-512-512.png') }}" color="#FFC107">

    <!-- PWA Meta Etiketleri -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#121212">
    <meta name="msapplication-TileColor" content="#121212">
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='icons/windows11/Square150x150Logo.scale-100.png') }}">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Çağrı">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icons/android/android-launchericon-512-512.png') }}">

    <!-- CSS Dosyaları -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    <!-- API Preconnect -->
    <link rel="preconnect" href="https://api.cagrivakti.com.tr">

    {% block extra_css %}{% endblock %}

    <script>
        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('SW Registered');
                        
                        // Periyodik Arka Plan Senkronizasyonu (Destekleyen tarayıcılar için)
                        if ('periodicSync' in reg) {
                            reg.periodicSync.register('refresh-vakitler', {
                                minInterval: 24 * 60 * 60 * 1000 // 24 saatte bir
                            }).catch(err => console.log('Periodic Sync failed', err));
                        }
                    })
                    .catch(err => console.log('SW Failed', err));
            });
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
</head>
<body>
    <!-- SVG Sprite -->
    <div style="display: none;">
        {% include 'img/icons.svg' %}
    </div>

    <nav class="navbar">
        <a href="{{ url_for('views.index') }}" class="nav-brand" title="Ana Sayfa">{% block brand_text %}ÇAĞRI{% endblock %}</a>
        <div id="navbar-vakit-countdown" style="display: none; margin-left: 15px; font-size: 0.85rem; font-weight: 600; color: var(--primary); white-space: nowrap;"></div>
        <button class="nav-toggle" id="navToggle" aria-label="Menüyü Aç/Kapat">
            <svg class="icon" aria-hidden="true"><use xlink:href="#fa-bars"></use></svg>
        </button>
        <div class="nav-links" id="navLinks">
            <a href="{{ url_for('views.sehir_secimi') }}" class="nav-link" title="İl ve İlçe Seçerek Namaz Vakitlerini Öğrenin">İl Seçimi</a>
            <a href="{{ url_for('views.imsakiye_secimi') }}" class="nav-link" title="{{ current_year }} Ramazan İmsakiye Çizelgesi ve İftar Vakitleri">İmsakiye</a>
            <a href="{{ url_for('views.kible_pusulasi') }}" class="nav-link" title="Harita Üzerinden Kıble Yönünü Bulun">Kıble</a>
            <a href="{{ url_for('views.ramazan_nedir') }}" class="nav-link" title="Ramazan Ayı Hakkında Merak Edilenler">Ramazan?</a>
            <a href="{{ url_for('views.orucu_bozan_durumlar') }}" class="nav-link" title="Orucu Bozan ve Bozmayan Durumlar Rehberi">Oruç Bozan Durumlar?</a>
            <a href="{{ url_for('views.bilgi_kosesi_liste') }}" class="nav-link" title="İslam ve Dini Konularda Yararlı Bilgiler">Bilgi Köşesi</a>
            <a href="{{ url_for('views.neden_biz') }}" class="nav-link" title="Neden Çağrı Vakti'ni Tercih Etmelisiniz?">Neden Biz?</a>
            <a href="{{ url_for('views.indir') }}" class="nav-link" title="Çağrı Vakti Mobil Uygulamasını Ücretsiz İndirin">Uygulamayı İndir</a>
            <a href="{{ url_for('views.ilkelerimiz') }}" class="nav-link" title="Yayın İlkelerimiz ve Değerlerimiz">İlkelerimiz</a>
            <a href="{{ url_for('views.iletisim') }}" class="nav-link" title="Görüş, Öneri ve İletişim">İletişim</a>
            <a href="{{ url_for('views.ataturk') }}" class="nav-link nav-link-ataturk" title="Ulu Önder Mustafa Kemal Atatürk'ü Saygıyla Anıyoruz" style="color: #ff5252 !important; font-weight: 600;">Atatürk</a>
            <!-- <a href="{{ url_for('views.api_dokuman') }}" class="nav-link">API Ulaşımı</a> -->
        </div>
    </nav>

    <main id="main-content">
        {% block content %}{% endblock %}
    </main>

    <footer class="landing-footer" style="padding: 60px 20px; background: var(--dark); text-align: center; border-top: 1px solid rgba(255,255,255,0.05); color: var(--gray);">
        <div class="footer-content">
            <div class="footer-brand">
                <svg class="icon"><use xlink:href="#fa-mosque"></use></svg>
                <span>Çağrı Vakti</span>
            </div>
            <div class="footer-popular-cities">
                <a href="{{ url_for('views.sehir_sayfasi', sehir='Istanbul', country='TR') }}">İstanbul</a>
                <a href="{{ url_for('views.sehir_sayfasi', sehir='Ankara', country='TR') }}">Ankara</a>
                <a href="{{ url_for('views.sehir_sayfasi', sehir='Izmir', country='TR') }}">İzmir</a>
                <a href="{{ url_for('views.sehir_sayfasi', sehir='Antalya', country='TR') }}">Antalya</a>
                <a href="{{ url_for('views.sehir_sayfasi', sehir='Trabzon', country='TR') }}">Trabzon</a>
                <a href="{{ url_for('views.sehir_sayfasi', sehir='Erzurum', country='TR') }}">Erzurum</a>
                <a href="{{ url_for('views.sehir_sayfasi', sehir='Diyarbakir', country='TR') }}">Diyarbakır</a>
            </div>
            <div class="footer-links">
                <a href="{{ url_for('views.ataturk') }}" class="footer-link-ataturk" style="color: var(--gray);">Atatürk</a>
                <a href="{{ url_for('views.sehir_secimi') }}" style="color: var(--gray);">Vakitler</a>
                <a href="{{ url_for('views.imsakiye_secimi') }}" style="color: var(--gray);">İmsakiye {{ current_year }}</a>
                <a href="{{ url_for('views.kible_pusulasi') }}" style="color: var(--gray);">Kıble</a>
                <a href="{{ url_for('views.indir') }}" style="color: var(--gray);">Uygulamayı İndir</a>
                <a href="{{ url_for('views.iletisim') }}" style="color: var(--gray);">İletişim</a>
                <a href="{{ url_for('views.neden_biz') }}" style="color: var(--gray);">Neden Biz?</a>
                <a href="{{ url_for('views.ilkelerimiz') }}" style="color: var(--gray);">İlkelerimiz</a>
                <a href="{{ url_for('views.sitene_ekle') }}" style="color: var(--gray);">Sitene Ekle</a>
                <a href="{{ url_for('views.api_dokuman') }}" style="color: var(--gray);">API</a>
                <a href="#" onclick="openTutorialModal(); return false;" style="color: var(--gray);">Tanıtım Turu</a>
            </div>
            <div class="footer-creator">
                <a href="https://www.instagram.com/yigitgulyurt/" target="_blank" rel="noopener noreferrer" style="color: var(--text); font-weight: 600;">BİR YİĞİT GÜLYURT PROJESİ</a>
            </div>
            
            <div class="national-identity" title="Varlığım Türk varlığına armağan olsun.">
                <svg class="icon" aria-hidden="true"><use xlink:href="#icon-turk-bayragi"></use></svg>
                <span>NE MUTLU TÜRKÜM DİYENE</span>
                <svg class="icon" aria-hidden="true"><use xlink:href="#icon-turk-bayragi"></use></svg>
            </div>

            <div class="footer-copy" style="color: var(--gray);">
                &copy; {{ current_year }} Çağrı Vakti. Bütün hakları saklıdır.
                <br>
                <svg class="icon" aria-hidden="true"><use xlink:href="#icon-turk-bayragi"></use></svg><small style="opacity: 0.8;">Sürüm {{ app_version }}</small>
                <svg class="icon" aria-hidden="true"><use xlink:href="#icon-turk-bayragi"></use></svg>
            </div>
        </div>
    </footer>

    {% block modals %}
    {% endblock %}

    {% set is_mobile = request.user_agent and (request.user_agent.platform in ['android', 'iphone', 'ipad'] or 'mobile' in request.user_agent.string.lower()) %}
    {% if is_mobile %}
    <!-- Custom Location Permission Modal -->
    <div id="locationPermissionModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <div class="modal-icon">
                <svg class="icon"><use xlink:href="#fa-map-marker-alt"></use></svg>
            </div>
            <h3>Size Özel Vakitler</h3>
            <p>Doğru namaz vakitlerini hesaplayabilmemiz için konum bilginize ihtiyacımız var. İzin verdiğinizde konumunuz anlık olarak alınacak ve cihazınıza kaydedilecektir.</p>
            <div class="modal-actions">
                <button id="denyLocationBtn" class="btn btn-secondary">Daha Sonra</button>
                <button id="allowLocationBtn" class="btn btn-primary">Konumu Paylaş</button>
            </div>
        </div>
    </div>

    <!-- Process Toast -->
    <div id="processToast" class="process-toast">
        <div class="toast-spinner"></div>
        <svg class="icon toast-success-icon"><use xlink:href="#fa-check-circle"></use></svg>
        <span id="toastMessage">İşlem yapılıyor...</span>
    </div>

    <!-- PWA Kurulum Banner'ı -->
    <div id="pwaInstallBanner" class="pwa-install-banner" title="Çağrı Vakti'ni Yükle">
        <div class="pwa-content">
            <div class="pwa-icon">
                <img src="{{ url_for('static', filename='icons/android/android-launchericon-96-96.png') }}" alt="Çağrı Vakti Uygulama İkonu" loading="lazy">
            </div>
            <div class="pwa-text">
                <h3>Çağrı Vakti'ni Yükleyin</h3>
                <p>Size özel namaz vakitleri ve imsakiye için uygulamayı ana ekranınıza ekleyin.</p>
            </div>
        </div>
        <div class="pwa-actions">
            <button id="pwaInstallBtn" class="btn btn-primary btn-sm" title="Uygulamayı Cihaza Yükle">
                <svg class="icon" aria-hidden="true" style="margin-right: 4px;"><use xlink:href="#fa-download-solid-full"></use></svg> Yükle
            </button>
            <button id="pwaCloseBtn" class="btn-close-pwa" title="Kapat">
                <svg class="icon" aria-hidden="true"><use xlink:href="#fa-xmark"></use></svg>
            </button>
        </div>
    </div>
    {% endif %}

    {% block extra_js %}{% endblock %}
    
    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/jquery-cagrivakti.js') }}"></script>
    
    <!-- In-App Browser Redirect Library -->
    <script src="{{ url_for('static', filename='js/InAppRedirect.js') }}" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            new InAppRedirect({
                appName: 'Çağrı Vakti',
                primaryColor: '#FFC107',
                onDetect: (data) => console.log('In-App Browser Detected:', data.ua),
                onAction: () => {
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'in_app_browser_action', { 'event_category': 'Engagement' });
                    }
                }
            });
        });
    </script>

    <!-- Global Scripts -->
    <script>
        function updateOnlineStatus() {
            // Sadece bağlantı koptuğunda offline sayfasına yönlendirilebilir 
            // ya da uygulama genelinde sessizce yönetilebilir.
            // Kullanıcının bahsettiği "kırmızı kutu" uyarısı burada tetiklenmiyor.
            console.log(navigator.onLine ? "Çevrimiçi" : "Çevrimdışı");
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Manifest URL'ini kullanıcı şehrine göre güncelle (Cache busting ve Parametre)
        window.addEventListener('DOMContentLoaded', () => {
            const userCityMatch = document.cookie.match(/user_city=([^;]+)/);
            if (userCityMatch && userCityMatch[1]) {
                const city = userCityMatch[1];
                const manifestLink = document.querySelector('link[rel="manifest"]');
                if (manifestLink) {
                    const url = new URL(manifestLink.href, window.location.origin);
                    url.searchParams.set('city', city);
                    // Tarayıcının cache'ini zorlamak için versiyon ekle
                    // url.searchParams.set('v', '2.11'); 
                    manifestLink.href = url.toString();
                    // console.log('Manifest updated for:', city);
                }
            }
        });

        // PWA Kurulum Mantığı
        window.deferredPrompt = null;
        const pwaBanner = document.getElementById('pwaInstallBanner');
        const installBtn = document.getElementById('pwaInstallBtn');
        const closeBtn = document.getElementById('pwaCloseBtn');

        // Şehir eşleştirme ve normalizasyon fonksiyonları (Global Scope'da tanımlı olabilir, kontrol et)
        const CITY_DISPLAY_MAPPING_GLOBAL = JSON.parse('{{ CITY_DISPLAY_NAME_MAPPING | tojson | safe if CITY_DISPLAY_NAME_MAPPING else "{}" }}');
        const REVERSE_CITY_MAPPING_GLOBAL = Object.fromEntries(
            Object.entries(CITY_DISPLAY_MAPPING_GLOBAL).map(([latin, turkish]) => [turkish, latin])
        );

        function getLatinNameGlobal(turkishName) {
             if (REVERSE_CITY_MAPPING_GLOBAL[turkishName]) {
                 return REVERSE_CITY_MAPPING_GLOBAL[turkishName];
             }
             const charMap = {
                 'ç': 'c', 'Ç': 'C', 'ğ': 'g', 'Ğ': 'G', 'ı': 'i', 'İ': 'I',
                 'ö': 'o', 'Ö': 'O', 'ş': 's', 'Ş': 'S', 'ü': 'u', 'Ü': 'U'
             };
             let normalized = turkishName.split('').map(char => charMap[char] || char).join('');
             return normalized.replace(/\s+/g, '-').replace(/[^A-Za-z0-9\-]/g, '');
        }

        // Banner'ı kapatma fonksiyonu
        function closePwaBanner() {
            if (pwaBanner) {
                pwaBanner.classList.remove('active');
                pwaBanner.classList.remove('ready');
                // Bu oturumda tekrar gösterme
                sessionStorage.setItem('pwaBannerDismissed', 'true');
            }
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            // Masaüstü cihazlarda PWA kurulumunu tamamen engelle
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (!isMobile) {
                e.preventDefault();
                console.log('PWA prompt suppressed on desktop');
                return;
            }

            // İndir sayfasında ise native banner'ın çıkmasına izin ver (preventDefault yapma)
            // Diğer sayfalarda otomatik gösterimi engelle
            const isDownloadPage = window.location.pathname.includes('/indir') || window.location.pathname.includes('/uygulamayi-indir');
            
            if (!isDownloadPage) {
                e.preventDefault();
            }
            
            // Olayı sakla ki daha sonra tetikleyebilelim
            window.deferredPrompt = e;
            
            // Eğer indir sayfasındaysak ve kullanıcı bir butona basarsa tetiklemek için hazır olsun
            if (isDownloadPage) {
                console.log('PWA native prompt allowed on download page');
                // İndir sayfasında özel butonları aktif et (varsa)
                const downloadPageBtn = document.getElementById('pwa-install-btn-main');
                if (downloadPageBtn) {
                    downloadPageBtn.style.display = 'inline-block';
                    downloadPageBtn.addEventListener('click', async () => {
                        if (window.deferredPrompt) {
                            window.deferredPrompt.prompt();
                            const { outcome } = await window.deferredPrompt.userChoice;
                            console.log(`User response to the install prompt: ${outcome}`);
                            window.deferredPrompt = null;
                            downloadPageBtn.style.display = 'none';
                        }
                    });
                }
                return; // Custom banner'ı gösterme
            }
            
            // Eğer reload sonrası ise hemen göster
            if (sessionStorage.getItem('reloadingForPWA')) {
                pwaBanner.classList.add('active');
                pwaBanner.classList.add('ready'); // Büyük ve ortalı görünüm
                
                const pwaText = document.querySelector('.pwa-text p');
                const pwaTitle = document.querySelector('.pwa-text h3');
                const installBtn = document.getElementById('pwaInstallBtn');
                
                if (pwaTitle) pwaTitle.textContent = 'Kuruluma Hazır';
                if (pwaText) pwaText.textContent = 'Her şey hazır, şimdi uygulamayı yükleyebilirsin.';
                if (installBtn) {
                    installBtn.innerHTML = '<svg class="icon" style="font-size: 1.2em; margin-right: 8px;"><use xlink:href="#fa-download-solid-full"></use></svg> Uygulamayı Yükle';
                    installBtn.classList.add('pulse-animation');
                }
                
                sessionStorage.removeItem('reloadingForPWA');
            } 
            // Eğer kullanıcı daha önce bu oturumda kapatmadıysa banner'ı göster
            else if (!sessionStorage.getItem('pwaBannerDismissed')) {
                setTimeout(() => {
                    pwaBanner.classList.add('active');
                }, 1000); // 1 saniye sonra göster
            }
        });

        // iOS ve Desteklenmeyen Tarayıcılar İçin Fallback Logic
        window.addEventListener('load', () => {
             const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
             const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
             const isDismissed = sessionStorage.getItem('pwaBannerDismissed');
             const isDownloadPage = window.location.pathname.includes('/indir') || window.location.pathname.includes('/uygulamayi-indir');
             
             if (isMobile && !isStandalone && !isDismissed && !isDownloadPage) {
                 // beforeinstallprompt'un tetiklenip tetiklenmediğini kontrol et (Android için biraz bekle)
                 setTimeout(() => {
                     if (!window.deferredPrompt) {
                         // Eğer native prompt yoksa, banner'ı yine de göster (Redirect modu)
                         if (pwaBanner) {
                             pwaBanner.classList.add('active');
                             // Buton metnini gerekirse güncelle (Şimdilik "Yükle" kalabilir)
                         }
                     }
                 }, 3000); // 3 saniye bekle
             }
        });

        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (window.deferredPrompt) {
                    // 1. Şehir kontrolü (Cookie)
                    const userCity = document.cookie.split('; ').find(row => row.startsWith('user_city='));
                    const pwaText = document.querySelector('.pwa-text p');
                    
                    if (!userCity) {
                        // MODAL VE TOAST ELEMENTLERİNİ SEÇ
                        const permissionModal = document.getElementById('locationPermissionModal');
                        const allowBtn = document.getElementById('allowLocationBtn');
                        const denyBtn = document.getElementById('denyLocationBtn');
                        const toast = document.getElementById('processToast');
                        const toastMsg = document.getElementById('toastMessage');

                        // Modalı göster
                        if (permissionModal) {
                            permissionModal.classList.add('active');
                            
                            // İzin ver butonuna tıklandığında
                            const handleAllow = async () => {
                                permissionModal.classList.remove('active');
                                
                                // Toast göster
                                if (toast && toastMsg) {
                                    toastMsg.textContent = 'Konum uydudan alınıyor...';
                                    toast.classList.add('active');
                                    toast.classList.remove('success'); // Reset success state
                                }

                                try {
                                    // Konum izni iste
                                    const position = await new Promise((resolve, reject) => {
                                        navigator.geolocation.getCurrentPosition(resolve, reject);
                                    });
                                    
                                    // Konum alındı
                                    if (toastMsg) toastMsg.textContent = 'Şehir bilgisi işleniyor...';
                                    
                                    const lat = position.coords.latitude;
                                    const lon = position.coords.longitude;
                                    
                                    // Reverse Geocoding
                                    let originalCityName = null;

                                    // 1. Deneme: Nominatim (OpenStreetMap)
                                    try {
                                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=tr`);
                                        if (response.ok) {
                                            const data = await response.json();
                                            if (data && data.address) {
                                                originalCityName = data.address.province || data.address.city || data.address.town || data.address.state;
                                            }
                                        }
                                    } catch (err) {
                                        console.warn('Nominatim failed, trying fallback...');
                                    }

                                    // 2. Deneme: BigDataCloud (Fallback)
                                    if (!originalCityName) {
                                        try {
                                            if (toastMsg) toastMsg.textContent = 'Alternatif servis deneniyor...';
                                            const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=tr`);
                                            if (response.ok) {
                                                const data = await response.json();
                                                // BigDataCloud field mapping
                                                originalCityName = data.city || data.locality || data.principalSubdivision;
                                            }
                                        } catch (err) {
                                            console.error('Fallback geocoding failed:', err);
                                        }
                                    }

                                    if (originalCityName) {
                                        // Başarılı
                                        originalCityName = originalCityName.replace(" İli", "").replace(" Province", "").trim();
                                        const latinCityName = getLatinNameGlobal(originalCityName);
                                        
                                        // Cookie ve LocalStorage güncelle
                                        document.cookie = `user_city=${latinCityName}; path=/; max-age=31536000; SameSite=Lax`;
                                        localStorage.setItem('user_city', latinCityName);
                                        
                                        if (toastMsg) toastMsg.textContent = `Şehir bulundu: ${originalCityName}`;
                                        if (toast) {
                                            toast.classList.add('success');
                                            // Başarı ikonunu göster (spinner gizlenir css ile)
                                            const icon = toast.querySelector('.toast-success-icon use');
                                            if(icon) icon.setAttribute('xlink:href', '#fa-check-circle');
                                        }
                                        
                                        // Biraz bekle sonra yenile
                                        setTimeout(() => {
                                            sessionStorage.setItem('reloadingForPWA', 'true');
                                            window.location.reload();
                                        }, 1500);
                                    } else {
                                        // Başarısız - Manuel Seçime Yönlendir
                                        console.error('All reverse geocoding attempts failed.');
                                        if (toastMsg) toastMsg.textContent = 'Otomatik konum bulunamadı.';
                                        if (toast) toast.classList.remove('success'); // Hata durumunda success olmamalı
                                        
                                        setTimeout(() => {
                                            if (toastMsg) toastMsg.textContent = 'Manuel seçime yönlendiriliyorsunuz...';
                                            // Hata durumunda da yönlendir
                                            window.location.href = "{{ url_for('views.sehir_secimi') }}";
                                        }, 1500);
                                    }

                                } catch (error) {
                                    console.log('Konum hatası:', error);
                                    if (toastMsg) toastMsg.textContent = 'Konum izni verilmedi.';
                                    setTimeout(() => {
                                        if (toast) toast.classList.remove('active');
                                    }, 2000);
                                }
                                
                                // Event listener'ı temizle (gerekirse)
                                allowBtn.removeEventListener('click', handleAllow);
                            };

                            allowBtn.onclick = handleAllow; // onclick kullanarak önceki listenerları ezeriz

                            // Vazgeç butonuna tıklandığında
                            denyBtn.onclick = () => {
                                permissionModal.classList.remove('active');
                            };
                            
                            return; // Modal sonucunu bekle
                        }
                    }

                    // 2. Yükleme işlemini başlat (Eğer şehir varsa)
                    window.deferredPrompt.prompt();
                    
                    const { outcome } = await window.deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    
                    window.deferredPrompt = null;
                    closePwaBanner();
                } else {
                    // Fallback: Native prompt yoksa (iOS vb.) indir sayfasına yönlendir
                    window.location.href = "{{ url_for('views.indir') }}";
                }
            });
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                closePwaBanner();
            });
        }

        // Uygulama yüklendiğinde
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA başarıyla yüklendi');
            pwaBanner.classList.remove('active');
        });

        // Navbar Toggle
        const navToggle = document.getElementById('navToggle');
        const navLinks = document.getElementById('navLinks');

        if (navToggle && navLinks) {
            navToggle.addEventListener('click', () => {
                navLinks.classList.toggle('active');
                const icon = navToggle.querySelector('use');
                if (navLinks.classList.contains('active')) {
                    icon.setAttribute('xlink:href', '#fa-xmark');
                    document.body.style.overflow = 'hidden';
                } else {
                    icon.setAttribute('xlink:href', '#fa-bars');
                    document.body.style.overflow = 'auto';
                }
            });

            // Menü linklerine tıklandığında menüyü kapat
            navLinks.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    navLinks.classList.remove('active');
                    navToggle.querySelector('use').setAttribute('xlink:href', '#fa-bars');
                    document.body.style.overflow = 'auto';
                });
            });
        }
    </script>

    {% block footer_js %}{% endblock %}
    <!-- Main JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Check if dark mode preference exists
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
    </script>
</body>
</html>