<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>{% block title %}Çağrı Vakti | Çağdaş, Hızlı ve Doğru{% endblock %}</title>

    <!-- SEO Meta Etiketleri -->
    <meta name="description" content="{% block description %}Dünya genelinde çağrı vakitleri, imsakiye ve dini içerikler. Çağdaş arayüz ve doğru verilerle yanınızdayız.{% endblock %}">
    <meta name="keywords" content="{% block keywords %}ramazan, imsakiye, çağrı vakitleri, iftar, sahur, ezan vakitleri, namaz saatleri{% endblock %}">
    <meta name="author" content="Çağrı Vakti">
    <link rel="canonical" href="{% block canonical %}https://cagrivakti.com.tr{{ request.path }}{% endblock %}">

    <!-- Open Graph Meta Etiketleri -->
    <meta property="og:title" content="{% block og_title %}Çağrı Vakti{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Günlük çağrı vakitleri ve Ramazan'a özel içerikler{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cagrivakti.com.tr{{ request.path }}">
    <meta property="og:image" content="https://cagrivakti.com.tr/static/icons/og-image.webp">
    <meta property="og:image:alt" content="Çağrı Vakti Namaz Vakitleri Logosu ve Tasarımı">

    <!-- Twitter Card Meta Etiketleri -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{{ self.og_title() }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ self.og_description() }}{% endblock %}">
    <meta name="twitter:image" content="https://cagrivakti.com.tr/static/icons/og-image.webp">
    <meta name="twitter:image:alt" content="Çağrı Vakti Namaz Vakitleri Sosyal Medya Paylaşım Görseli">

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {% block json_ld %}
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Çağrı Vakti",
      "url": "https://cagrivakti.com.tr",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://cagrivakti.com.tr/sehir/{search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    {% endblock %}
    
    {% block breadcrumb_json_ld %}{% endblock %}
    </script>

    <!-- Favicon ve App Icons -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icons/favicon.ico') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/ios/180.png') }}">
    <link rel="mask-icon" href="{{ url_for('static', filename='icons/android/android-launchericon-512-512.png') }}" color="#FFC107">

    <!-- PWA Meta Etiketleri -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#121212">
    <meta name="msapplication-TileColor" content="#121212">
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='icons/windows11/Square150x150Logo.scale-100.png') }}">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Çağrı">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" href="{{ url_for('static', filename='icons/android/android-launchericon-512-512.png') }}">

    <!-- Fontlar
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"> -->

    <!-- CSS Dosyaları -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    <!-- In-App Browser Redirect Library -->
    <script src="{{ url_for('static', filename='js/InAppRedirect.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            new InAppRedirect({
                appName: 'Çağrı Vakti',
                primaryColor: '#FFC107',
                onDetect: (data) => console.log('In-App Browser Detected:', data.ua),
                onAction: () => {
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'in_app_browser_action', { 'event_category': 'Engagement' });
                    }
                }
            });
        });
    </script>

    {% block extra_css %}{% endblock %}

    <script>
        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('SW Registered');
                        
                        // Periyodik Arka Plan Senkronizasyonu (Destekleyen tarayıcılar için)
                        if ('periodicSync' in reg) {
                            reg.periodicSync.register('refresh-vakitler', {
                                minInterval: 24 * 60 * 60 * 1000 // 24 saatte bir
                            }).catch(err => console.log('Periodic Sync failed', err));
                        }
                    })
                    .catch(err => console.log('SW Failed', err));
            });
        }
    </script>
</head>
<body>
    <!-- SVG Sprite -->
    <div style="display: none;">
        {% include 'img/icons.svg' %}
    </div>

    <nav class="navbar">
        <a href="{{ url_for('views.index') }}" class="nav-brand" title="Ana Sayfa">{% block brand_text %}ÇAĞRI{% endblock %}</a>
        <div id="navbar-vakit-countdown" style="display: none; margin-left: 15px; font-size: 0.85rem; font-weight: 600; color: var(--primary); white-space: nowrap;"></div>
        <button class="nav-toggle" id="navToggle" aria-label="Menüyü Aç/Kapat">
            <svg class="icon" aria-hidden="true"><use xlink:href="#fa-bars"></use></svg>
        </button>
        <div class="nav-links" id="navLinks">
            <a href="{{ url_for('views.sehir_secimi') }}" class="nav-link" title="Şehir Seçimi Sayfası">İl Seçimi</a>
            <a href="{{ url_for('views.kible_pusulasi') }}" class="nav-link" title="Online Kıble Pusulası">Kıble Pusulası</a>
            <a href="{{ url_for('views.imsakiye_secimi') }}" class="nav-link" title="{{ current_year }} İmsakiye Çizelgesi">Vakit Çizelgesi</a>
            <a href="{{ url_for('views.ramazan_nedir') }}" class="nav-link" title="Ramazan Hakkında Bilgiler">Ramazan Kılavuzu</a>
            <a href="{{ url_for('views.orucu_bozan_durumlar') }}" class="nav-link" title="Oruç Bozan Durumları">Oruç Bozan Durumları</a>
            <a href="{{ url_for('views.bilgi_kosesi_liste') }}" class="nav-link" title="Dini Bilgiler Bilgi Köşesi">Bilgi Köşesi</a>
            <a href="{{ url_for('views.neden_biz') }}" class="nav-link" title="Çağrı Vakti İlkeleri">Neden Biz?</a>
            <a href="{{ url_for('views.indir') }}" class="nav-link" title="Mobil Uygulamayı İndir">Uygulamayı İndir</a>
            <a href="{{ url_for('views.ilkelerimiz') }}" class="nav-link" title="Çağrı Vakti İlkeleri">İlkelerimiz</a>
            <a href="{{ url_for('views.iletisim') }}" class="nav-link" title="Bize Ulaşın">İletişim</a>
            <a href="{{ url_for('views.ataturk') }}" class="nav-link" title="Mustafa Kemal Atatürk" style="color: #e30a17 !important; font-weight: 600;">Atatürk</a>
            <!-- <a href="{{ url_for('views.api_dokuman') }}" class="nav-link">API Ulaşımı</a> -->
        </div>
    </nav>

    {% block content %}{% endblock %}

    <footer class="landing-footer" style="padding: 60px 20px; background: var(--dark); text-align: center; border-top: 1px solid rgba(255,255,255,0.05);">
        <div class="footer-content">
            <div class="footer-brand">
                <svg class="icon"><use xlink:href="#fa-mosque"></use></svg>
                <span>Çağrı Vakti</span>
            </div>
            <div class="footer-links">
                <a href="{{ url_for('views.sehir_secimi') }}">Vakitler</a>
                <a href="{{ url_for('views.kible_pusulasi') }}">Kıble Pusulası</a>
                <a href="{{ url_for('views.imsakiye_secimi') }}">İmsakiye {{ current_year }}</a>
                <a href="{{ url_for('views.neden_biz') }}">Neden Biz?</a>
                <a href="{{ url_for('views.api_dokuman') }}">API</a>
                <a href="{{ url_for('views.ataturk') }}">Atatürk</a>
                <a href="{{ url_for('views.ilkelerimiz') }}">İlkelerimiz</a>
                <a href="{{ url_for('views.indir') }}">Uygulamayı İndir</a>
                <a href="{{ url_for('views.iletisim') }}">İletişim</a>
            </div>
            <div class="footer-creator">
                <a href="https://www.instagram.com/yigitgulyurt/" target="_blank" rel="noopener noreferrer">BİR YİĞİT GÜLYURT PROJESİ</a>
            </div>
            <div class="footer-copy">
                &copy; {{ current_year }} Çağrı Vakti. Bütün hakları saklıdır.
                <br><small style="opacity: 0.5;">Sürüm {{ app_version }}</small>
            </div>
        </div>
    </footer>

    {% block modals %}
    {% endblock %}

    <!-- PWA Kurulum Banner'ı -->
    <div id="pwaInstallBanner" class="pwa-install-banner" title="Uygulamayı Yükle">
        <div class="pwa-content">
            <div class="pwa-icon">
                <img src="{{ url_for('static', filename='icons/android/android-launchericon-96-96.png') }}" alt="Çağrı Vakti Uygulama İkonu" loading="lazy">
            </div>
            <div class="pwa-text">
                <h3>Uygulamayı Yükleyin</h3>
                <p>Çağrı vakitlerine hızlı erişim için ana ekranınıza ekleyin.</p>
            </div>
        </div>
        <div class="pwa-actions">
            <button id="pwaInstallBtn" class="btn btn-primary btn-sm" title="Uygulamayı Cihaza Yükle">Yükle</button>
            <button id="pwaCloseBtn" class="btn-close-pwa" title="Kapat">
                <svg class="icon" aria-hidden="true"><use xlink:href="#fa-xmark"></use></svg>
            </button>
        </div>
    </div>

    {% block extra_js %}{% endblock %}
    
    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    
    <!-- Global Scripts -->
    <script>
        // Bağlantı Durumu Kontrolü
        function updateOnlineStatus() {
            // Sadece bağlantı koptuğunda offline sayfasına yönlendirilebilir 
            // ya da uygulama genelinde sessizce yönetilebilir.
            // Kullanıcının bahsettiği "kırmızı kutu" uyarısı burada tetiklenmiyor.
            console.log(navigator.onLine ? "Çevrimiçi" : "Çevrimdışı");
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Manifest URL'ini kullanıcı şehrine göre güncelle (Cache busting ve Parametre)
        window.addEventListener('DOMContentLoaded', () => {
            const userCityMatch = document.cookie.match(/user_city=([^;]+)/);
            if (userCityMatch && userCityMatch[1]) {
                const city = userCityMatch[1];
                const manifestLink = document.querySelector('link[rel="manifest"]');
                if (manifestLink) {
                    const url = new URL(manifestLink.href, window.location.origin);
                    url.searchParams.set('city', city);
                    // Tarayıcının cache'ini zorlamak için versiyon ekle
                    // url.searchParams.set('v', '2.11'); 
                    manifestLink.href = url.toString();
                    // console.log('Manifest updated for:', city);
                }
            }
        });

        // PWA Kurulum Mantığı
        let deferredPrompt;
        const pwaBanner = document.getElementById('pwaInstallBanner');
        const installBtn = document.getElementById('pwaInstallBtn');
        const closeBtn = document.getElementById('pwaCloseBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Chrome 67 ve öncesinde otomatik gösterimi engelle
            e.preventDefault();
            // Olayı sakla ki daha sonra tetikleyebilelim
            deferredPrompt = e;
            
            // Eğer reload sonrası ise hemen göster
            if (sessionStorage.getItem('reloadingForPWA')) {
                pwaBanner.classList.add('active');
                pwaBanner.classList.add('ready'); // Büyük ve ortalı görünüm
                
                const pwaText = document.querySelector('.pwa-text p');
                const installBtn = document.getElementById('pwaInstallBtn');
                
                if (pwaText) pwaText.textContent = 'Konumunuz doğrulandı. Uygulamayı hemen yükleyebilirsiniz.';
                if (installBtn) {
                    installBtn.textContent = 'Yükle (Hazır)';
                    installBtn.classList.add('pulse-animation');
                }
                
                sessionStorage.removeItem('reloadingForPWA');
            } 
            // Eğer kullanıcı daha önce bu oturumda kapatmadıysa banner'ı göster
            else if (!sessionStorage.getItem('pwaBannerDismissed')) {
                setTimeout(() => {
                    pwaBanner.classList.add('active');
                }, 3000); // 3 saniye sonra göster
            }
        });

        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    // 1. Şehir kontrolü (Cookie)
                    const userCity = document.cookie.split('; ').find(row => row.startsWith('user_city='));
                    const pwaText = document.querySelector('.pwa-text p');
                    
                    if (!userCity) {
                        // Şehir yoksa bulmaya çalış
                        const originalText = installBtn.textContent;
                        
                        installBtn.textContent = 'Hazırlanıyor...';
                        if (pwaText) pwaText.textContent = 'Size özel vakitleri sunabilmek için konumunuz alınıyor...';
                        installBtn.disabled = true;

                        try {
                            // Konum izni iste
                            if (navigator.geolocation) {
                                const position = await new Promise((resolve, reject) => {
                                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                                        timeout: 10000,
                                        maximumAge: 60000
                                    });
                                });

                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;

                                // Şehir ismini bul (Nominatim)
                                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=tr`);
                                const data = await response.json();

                                if (data && data.address) {
                                    let originalCityName = data.address.province || data.address.city || data.address.town || data.address.state;
                                    
                                    if (originalCityName) {
                                        originalCityName = originalCityName.replace(" İli", "").replace(" Province", "").trim();
                                        
                                        // Basit Latin çevirisi ve Normalizasyon
                                        const charMap = {
                                            'ç': 'c', 'Ç': 'C', 'ğ': 'g', 'Ğ': 'G',
                                            'ı': 'i', 'İ': 'I', 'ö': 'o', 'Ö': 'O',
                                            'ş': 's', 'Ş': 'S', 'ü': 'u', 'Ü': 'U'
                                        };
                                        const latinCityName = originalCityName.split('').map(char => charMap[char] || char).join('')
                                            .replace(/\s+/g, '-').replace(/[^A-Za-z0-9\-]/g, '');

                                        // Cookie'ye kaydet
                                        document.cookie = `user_city=${latinCityName}; path=/; max-age=31536000; SameSite=Lax`;
                                        
                                        // LocalStorage'a da kaydet (Konum bul sayfası için)
                                        localStorage.setItem('user_city', latinCityName);
                                        
                                        if (pwaText) pwaText.textContent = `${originalCityName} bulundu! Uygulama verileri güncelleniyor...`;
                                        
                                        // Sayfayı yenile ve işlemi sonlandır
                                        sessionStorage.setItem('reloadingForPWA', 'true');
                                        
                                        await new Promise(r => setTimeout(r, 1000));
                                        window.location.reload();
                                        return;
                                    }
                                }
                            }
                        } catch (err) {
                            console.error("Konum alınamadı:", err);
                            if (pwaText) pwaText.textContent = 'Konum alınamadı, varsayılan ayarlarla devam ediliyor.';
                            installBtn.textContent = originalText;
                            installBtn.disabled = false;
                            // Hata durumunda normal akışa devam et
                        }
                    }

                    // Eğer buraya geldiysek ya cookie vardı ya da konum alınamadı (varsayılan kurulum)
                    try {
                        // Kurulum istemini göster
                        deferredPrompt.prompt();
                        // Kullanıcının cevabını bekle
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`PWA kurulum sonucu: ${outcome}`);
                        // İstem kullanıldı, temizle
                        deferredPrompt = null;
                        // Banner'ı gizle
                        pwaBanner.classList.remove('active');
                    } catch (promptError) {
                         console.error("Otomatik kurulum başlatılamadı:", promptError);
                         if (pwaText) pwaText.textContent = 'Kurulum hazır! Yükle butonuna tekrar basın.';
                         installBtn.textContent = 'Yükle';
                         installBtn.disabled = false;
                    }
                }
            });
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                pwaBanner.classList.remove('active');
                // Bu oturumda tekrar gösterme
                sessionStorage.setItem('pwaBannerDismissed', 'true');
            });
        }

        // Uygulama yüklendiğinde
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA başarıyla yüklendi');
            pwaBanner.classList.remove('active');
        });

        // Navbar Toggle
        const navToggle = document.getElementById('navToggle');
        const navLinks = document.getElementById('navLinks');

        if (navToggle && navLinks) {
            navToggle.addEventListener('click', () => {
                navLinks.classList.toggle('active');
                const icon = navToggle.querySelector('use');
                if (navLinks.classList.contains('active')) {
                    icon.setAttribute('xlink:href', '#fa-xmark');
                    document.body.style.overflow = 'hidden';
                } else {
                    icon.setAttribute('xlink:href', '#fa-bars');
                    document.body.style.overflow = 'auto';
                }
            });

            // Menü linklerine tıklandığında menüyü kapat
            navLinks.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    navLinks.classList.remove('active');
                    navToggle.querySelector('use').setAttribute('xlink:href', '#fa-bars');
                    document.body.style.overflow = 'auto';
                });
            });
        }
    </script>

    {% block footer_js %}{% endblock %}
</body>
</html>