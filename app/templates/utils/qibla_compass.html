{% extends "base.html" %}

{% block title %}{{ seo_title }}{% endblock %}

{% block extra_css %}
<style>
    /* Sadece Mobil UyarÄ± EkranÄ± */
    #mobile-only-warning {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--dark);
        z-index: 10000;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
        color: var(--text);
    }

    .warning-card {
        background-color: var(--card-bg);
        border: 1px solid var(--hover-color);
        padding: 40px 30px;
        border-radius: 24px;
        max-width: 420px;
        width: 100%;
        box-shadow: var(--card-shadow);
    }

    .warning-icon-wrapper {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto 25px;
        background: rgba(255, 193, 7, 0.1);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .warning-icon {
        font-size: 40px;
        color: var(--primary);
    }

    .warning-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 16px;
        color: var(--text);
    }

    .warning-text {
        font-size: 15px;
        line-height: 1.6;
        color: var(--gray);
        margin-bottom: 30px;
    }

    .qr-container {
        background: white;
        padding: 16px;
        border-radius: 16px;
        display: inline-block;
        margin-bottom: 12px;
    }

    .qr-label {
        display: block;
        color: #000000;
        font-weight: 600;
        font-size: 14px;
        margin-top: 15px;
    }

    .device-badges {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 30px;
    }

    .badge {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--gray);
        background: var(--hover-color);
        padding: 6px 14px;
        border-radius: 100px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    /* MasaÃ¼stÃ¼nde ana iÃ§eriÄŸi gizle */
    @media (min-width: 1025px) {
        .qibla-page { display: none !important; }
        #mobile-only-warning { display: flex; }
    }

    :root {
        --primary-color: var(--primary);
        --compass-size: 285px;
        --compass-size-mobile: 268.5px;
    }

    .qibla-page {
        background: var(--dark); /* Project dark background */
        min-height: 100vh;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow-x: hidden;
        position: relative;
        color: var(--text);
    }

    #camera-feed {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 0;
        opacity: 0.6;
        display: none;
    }

    .qibla-content-overlay {
        position: relative;
        z-index: 1;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .qibla-header {
        text-align: center;
        margin-bottom: 30px;
        max-width: 700px;
        animation: fadeInDown 0.8s ease-out;
        padding: 0 10px;
    }

    .qibla-header h1 {
        font-size: 1.8rem;
        font-weight: 800;
        letter-spacing: -0.5px;
        background: linear-gradient(to right, #fff, var(--primary));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
    }

    .qibla-header p {
        color: rgba(255,255,255,0.6);
        font-size: 0.85rem;
        line-height: 1.5;
    }

    /* Compass Container */
    .compass-wrapper {
        position: relative;
        width: var(--compass-size);
        height: var(--compass-size);
        margin: 20px auto;
        perspective: 1000px;
        animation: zoomIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .compass-outer {
        position: relative;
        width: var(--compass-size);
        height: var(--compass-size);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 0 50px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        margin: 0 auto;
        box-sizing: border-box; /* Ã–nemli: Border geniÅŸliÄŸi hesaplamayÄ± bozmasÄ±n */
    }

    .compass-dial {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        transition: none !important;
        will-change: transform;
        background: transparent;
        box-sizing: border-box;
    }

    .mark {
        position: absolute;
        width: 1px;
        height: 8px;
        background: rgba(255,255,255,0.3);
        left: 50%;
        top: 0;
        transform: translateX(-50%);
        /* transform-origin JS tarafÄ±ndan createMarks iÃ§inde atanÄ±yor */
    }

    .mark.cardinal {
        height: 12px;
        width: 2px;
        background: #fff;
    }

    .cardinal-label {
        position: absolute;
        font-weight: 800; /* Daha belirgin */
        font-size: 16px; /* Biraz bÃ¼yÃ¼tÃ¼ldÃ¼ */
        color: #fff;
        left: 50%;
        /* top JS ile dinamik ayarlanacak */
        transform: translateX(-50%);
        text-shadow: 0 2px 8px rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 20px; /* Harf iÃ§in sabit geniÅŸlik alanÄ± */
        height: 20px;
    }

    /* Fixed North Needle (Optional, helps orientation) */
    .needle-fixed {
        position: absolute;
        width: 2px;
        height: 100%;
        background: linear-gradient(to bottom, var(--primary) 50%, transparent 50%);
        z-index: 5;
        opacity: 0.5;
    }

    /* Qibla Pointer (The main one) */
    .qibla-pointer {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 30px; /* Ok geniÅŸliÄŸi */
        height: 100%; /* Dairenin Ã§apÄ± kadar */
        z-index: 10;
        display: none;
        pointer-events: none;
        transform: translate(-50%, -50%); /* Tam merkeze oturt */
        transform-origin: center center;
    }

    .qibla-pointer .pointer-line {
        position: absolute;
        top: 0;
        left: 50%;
        width: 6px; /* Daha dolgun */
        height: 50%;
        /* Hub'dan Ã§Ä±kÄ±yormuÅŸ gibi gÃ¶rÃ¼nmesi iÃ§in gradient yÃ¶nÃ¼nÃ¼ deÄŸiÅŸtirdim */
        background: linear-gradient(to top, transparent 0%, rgba(255, 193, 7, 0.2) 15%, var(--primary) 40%);
        transform: translateX(-50%);
        border-radius: 3px;
        transition: all 0.3s ease;
    }

    /* HizalanÄ±nca Ok Hub ile BÃ¼tÃ¼nleÅŸsin */
    .is-aligned .qibla-pointer .pointer-line {
        background: linear-gradient(to top, var(--primary) 0%, #fff 100%);
        width: 8px;
        box-shadow: 0 0 15px var(--primary);
    }

    /* HizalanÄ±nca Okun Rengi ve ParlamasÄ± */
    .is-aligned .qibla-pointer svg {
        fill: #fff !important;
        filter: drop-shadow(0 0 15px var(--primary));
        transform: scale(1.2);
    }

    /* Center Hub - Puzzle Dock TasarÄ±mÄ± */
    .compass-center {
        position: absolute;
        width: 24px;
        height: 24px;
        background: radial-gradient(circle, #fff 30%, #f0f0f0 100%);
        border: 3px solid var(--hover-color); /* Daha koyu, mekanik bir Ã§erÃ§eve */
        border-radius: 50%;
        z-index: 20;
        box-shadow: 0 0 15px rgba(0,0,0,0.4), inset 0 2px 5px rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Sabit Ä°leri GÃ¶stergesi (Target Dock) */
    .compass-center::after {
        content: '';
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 12px;
        height: 12px;
        background: var(--primary);
        clip-path: polygon(50% 0%, 0% 100%, 100% 100%); /* ÃœÃ§gen oyuk hissi */
        transition: all 0.3s ease;
    }

    /* Ä°Ã§ Nokta (Core) */
    .compass-center::before {
        content: '';
        width: 8px;
        height: 8px;
        background: var(--hover-color);
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    /* HizalanÄ±nca ParÃ§alar BirleÅŸsin */
    .is-aligned .compass-center {
        border-color: var(--primary);
        box-shadow: 0 0 30px var(--primary);
        transform: scale(1.1);
    }

    .is-aligned .compass-center::after {
        opacity: 0;
        visibility: hidden;
        transform: translateX(-50%) scale(0.5);
    }

    .is-aligned .compass-center::before {
        background: var(--primary);
        transform: scale(1.2);
    }

    /* Stats Grid */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        width: 100%;
        max-width: 400px;
        margin-top: 10px;
        animation: fadeInUp 0.8s ease-out 0.4s both;
    }

    .stat-card {
        background: var(--card-bg);
        padding: 15px;
        border-radius: 15px;
        text-align: center;
        border: 1px solid rgba(255, 193, 7, 0.1);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        border-color: rgba(255, 193, 7, 0.3);
        transform: translateY(-2px);
    }

    .stat-card .label {
        display: block;
        font-size: 0.7rem;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
    }

    .stat-card .value {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary);
    }

    .stat-card.full {
        grid-column: span 2;
    }

    /* Warning Footer Style */
    .qibla-warning {
        margin-top: 20px;
        padding: 12px 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        font-size: 0.75rem;
        line-height: 1.5;
        color: rgba(255, 255, 255, 0.7);
        display: flex;
        flex-direction: column; /* Alt alta sÄ±ralamak iÃ§in */
        gap: 8px; /* Metinler arasÄ± boÅŸluk */
        align-items: flex-start;
        max-width: 400px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: fadeInUp 0.8s ease-out 0.6s both;
    }

    .qibla-warning .warning-item {
        display: flex;
        gap: 10px;
        align-items: flex-start;
    }

    .qibla-warning svg {
        flex-shrink: 0;
        width: 14px;
        height: 14px;
        fill: var(--primary);
        margin-top: 2px;
    }

    .qibla-warning strong {
        color: var(--primary);
    }

    /* Action Buttons */
    .action-group {
        margin-top: 25px;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        gap: 15px;
        animation: fadeInUp 0.8s ease-out 0.8s both;
    }

    .btn-qibla {
        padding: 14px 30px;
        border-radius: 15px;
        font-weight: 700;
        font-size: 0.95rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: none;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: var(--primary);
        color: var(--dark);
        width: 100%;
        max-width: 280px;
        box-shadow: 0 10px 20px rgba(255, 193, 7, 0.1);
    }

    .btn-secondary {
        display: flex;
        background: rgba(255,255,255,0.08);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        color: #fff;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .btn-secondary:active {
        transform: scale(0.95);
        background: rgba(255,255,255,0.15);
    }

    /* Status Bar kaldÄ±rÄ±ldÄ± veya gizlendi */
    .status-indicator {
        display: none !important;
    }

    /* Map Integration */
    .map-preview {
        width: 100%;
        max-width: 400px;
        height: 120px;
        margin-top: 20px;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        display: none;
        border: 1px solid rgba(255,255,255,0.1);
    }

    /* Debug Panel */
    .debug-panel {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.85);
        color: #00ff00;
        padding: 12px;
        border-radius: 10px;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        z-index: 9999;
        max-height: 150px;
        overflow-y: auto;
        width: 200px;
        pointer-events: none;
        display: none; /* VarsayÄ±lan gizli , none*/
        border: 1px solid rgba(0,255,0,0.3);
    }

    /* Smoothing & Transitions */
    .compass-dial, .qibla-pointer {
        /* Transition'larÄ± kaldÄ±rÄ±yoruz, JS ile yÃ¶neteceÄŸiz */
        transition: none !important;
        will-change: transform;
    }

    .is-aligned .qibla-pointer {
        filter: drop-shadow(0 0 15px var(--primary));
        transform: scale(1.1);
    }

    .is-aligned .compass-outer {
        box-shadow: 0 0 40px rgba(255, 193, 7, 0.4);
        border-color: var(--primary);
    }

    /* Success State */
    .is-aligned .compass-outer {
        border-color: var(--primary);
        box-shadow: 0 0 40px rgba(255, 193, 7, 0.4);
        background: rgba(255, 193, 7, 0.1);
    }

    .is-aligned .qibla-pointer .pointer-line {
        background: var(--primary);
        box-shadow: 0 0 15px var(--primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
        :root {
            --compass-size: var(--compass-size-mobile);
        }
        .mark { transform-origin: 50% 132px; }
        .cardinal-label { transform-origin: 50% 132px; }
        .qibla-pointer { height: 240px; }
    }
</style>
{% endblock %}

{% block content %}
<!-- MasaÃ¼stÃ¼ UyarÄ± EkranÄ± -->
<div id="mobile-only-warning">
    <div class="warning-card">
        <div class="warning-icon-wrapper">
            <div class="warning-icon">ðŸ“±</div>
        </div>
        <h2 class="warning-title">Mobil Cihaz Gereklidir</h2>
        <p class="warning-text">
            KÄ±ble PusulasÄ±, hassas yÃ¶n Ã¶lÃ§Ã¼mÃ¼ iÃ§in cihazÄ±nÄ±zdaki <strong>manyetik sensÃ¶rleri</strong> ve <strong>jiroskopu</strong> kullanÄ±r. 
            Bu deneyim sadece akÄ±llÄ± telefonlarda mevcuttur.
        </p>
        
        <div class="qr-code">
            <canvas id="qr-code-canvas"></canvas>
            <span class="qr-label">Hemen Telefondan AÃ§</span>
        </div>

        <div class="device-badges">
            <div class="badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.05 20.28c-.96.95-2.06 1.92-3.72 1.92-1.61 0-2.14-1.02-4.05-1.02-1.94 0-2.52 1.02-4.05 1.02-1.58 0-2.82-1.14-3.79-2.53-1.97-2.86-3.48-8.08-1.44-11.64 1.02-1.77 2.83-2.88 4.81-2.88 1.51 0 2.93 1.04 3.86 1.04.93 0 2.64-1.24 4.46-1.06 1.15.05 2.21.46 3.01 1.18-.09.05-1.81 1.05-1.81 3.12 0 2.49 2.03 3.33 2.07 3.35-.02.05-.31 1.07-1.05 2.14-.64.92-1.3 1.84-2.34 1.86-.98.01-1.32-.59-2.45-.59-1.14 0-1.5.58-2.43.61-.99.03-1.67-.93-2.32-1.86-1.34-1.9-2.34-5.38-1-7.72.67-1.16 1.86-1.89 3.17-1.89 1.14 0 2.21.78 2.91.78.69 0 2-.96 3.34-.82 1.04.04 1.98.42 2.62 1.05-.08.05-1.57.91-1.57 2.72 0 2.16 1.76 2.89 1.8 2.91zM12.03 5.44c-.01-.15-.03-.31-.03-.47 0-2.26 1.88-4.1 4.2-4.1.16 0 .32.01.47.03-.05 2.31-1.98 4.14-4.29 4.14-.11 0-.23-.01-.35-.02z"/></svg>
                iOS
            </div>
            <div class="badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.523 15.3414c-.5511 0-.9993-.4486-.9993-.9997s.4482-.9997.9993-.9997c.5511 0 .9993.4486.9993.9997s-.4482.9997-.9993.9997zm-11.046 0c-.5511 0-.9993-.4486-.9993-.9997s.4482-.9997.9993-.9997c.5511 0 .9993.4486.9993.9997s-.4482.9997-.9993.9997zm11.4045-6.0206l1.9973-3.4592c.1054-.1825.0427-.4149-.1398-.5203-.1821-.1054-.4141-.0431-.5195.1394l-2.0163 3.4921c-1.4475-.6625-3.0641-1.0366-4.7705-1.0366-1.7064 0-3.323.3741-4.7705 1.0366l-2.0163-3.4921c-.1054-.1825-.3374-.2448-.5195-.1394-.1825.1054-.2452.3378-.1398.5203l1.9973 3.4592c-2.9031 1.5543-4.9126 4.4571-5.2536 7.8924h18.2865c-.341-3.4353-2.3505-6.3381-5.2536-7.8924z"/></svg>
                Android
            </div>
        </div>
    </div>
</div>

<div class="qibla-page">
    <video id="camera-feed" autoplay playsinline muted></video>

    <div class="qibla-content-overlay">
        <div class="qibla-header">
            <h1>KÄ±bleyi KeÅŸfedin</h1>
            <p>Hassas sensÃ¶r teknolojisi ve artÄ±rÄ±lmÄ±ÅŸ gerÃ§eklik (AR) desteÄŸi ile kÄ±ble yÃ¶nÃ¼nÃ¼zÃ¼ saniyeler iÃ§inde, en doÄŸru ÅŸekilde bulun.</p>
        </div>

        <div class="compass-wrapper" id="compass-wrapper">
            <div class="compass-outer">
                <div class="compass-dial" id="compass-dial">
                    <div class="compass-marks" id="compass-marks"></div>
                </div>
                
                <div class="compass-center"></div>

                <div class="qibla-pointer" id="qibla-pointer">
                    <div class="pointer-line"></div>
                    <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%);">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="var(--primary)">
                            <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <span class="label">Pusula</span>
                <span class="value" id="heading-val">0Â°</span>
            </div>
            <div class="stat-card">
                <span class="label">KÄ±ble AÃ§Ä±sÄ±</span>
                <span class="value" id="qibla-val">--</span>
            </div>
            <div class="stat-card full">
                <span class="label">Kabe'ye Mesafe</span>
                <span class="value" id="distance-val">-- km</span>
            </div>
        </div>

        <div class="qibla-warning">
            <div class="warning-item">
                <svg class="icon"><use xlink:href="#fa-circle-info"></use></svg>
                <span><strong>Dikkat:</strong> En doÄŸru sonuÃ§ iÃ§in telefonunuzu dik tutunuz. <br> </span>
            </div>
            <div class="warning-item">
                <svg class="icon"><use xlink:href="#fa-circle-info"></use></svg>
                <span><strong>Dikkat:</strong> Manyetik sapma ve cihaz hassasiyeti nedeniyle 1-3 derecelik farklar oluÅŸabilir. En doÄŸru sonuÃ§ iÃ§in cihazÄ±nÄ±zÄ± 8 Ã§izerek kalibre ediniz.</span>
            </div>
        </div>

        <div class="action-group">
            <button id="permission-btn" class="btn-qibla">
                <svg class="icon" style="width:20px;height:20px;"><use xlink:href="#fa-bolt"></use></svg>
                PusulayÄ± BaÅŸlat
            </button>
            <button id="camera-toggle" class="btn-qibla btn-secondary">
                <svg class="icon" style="width:20px;height:20px;"><use xlink:href="#fa-camera-solid"></use></svg>
                Kamera Modu
            </button>
        </div>

        <div id="debug-panel" class="debug-panel"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- QR Code Library -->
<script src="{{ url_for('static', filename='js/qrious.min.js') }}"></script>
<script>
    // QR Code Generation
    document.addEventListener('DOMContentLoaded', () => {
        const qrElement = document.getElementById('qr-code-canvas');
        if (qrElement && typeof QRious !== 'undefined') {
            try {
                new QRious({
                    element: qrElement,
                    value: window.location.href,
                    size: 160,
                    padding: 10,
                    level: 'M',
                    foreground: '#000000',
                    background: 'white'
                });
            } catch (e) {
                console.warn('QRious init failed:', e);
            }
        }
    });

    const dial = document.getElementById('compass-dial');
    const marksContainer = document.getElementById('compass-marks');
    const permBtn = document.getElementById('permission-btn');
    const qiblaPointer = document.getElementById('qibla-pointer');
    const qiblaVal = document.getElementById('qibla-val');
    const headingVal = document.getElementById('heading-val');
    const distanceVal = document.getElementById('distance-val');
    const wrapper = document.getElementById('compass-wrapper');
    const debugPanel = document.getElementById('debug-panel');
    const cameraFeed = document.getElementById('camera-feed');
    const cameraToggle = document.getElementById('camera-toggle');

    let userLat, userLon, qiblaAngle = 0;
    let magneticDeclination = 0; // Manyetik sapma (varsayÄ±lan 0)

    // Basit manyetik sapma tahmini (WMM modelinin Ã§ok basitleÅŸtirilmiÅŸ hali)
    // TÃ¼rkiye iÃ§in genelde +5 ile +6 derece civarÄ±ndadÄ±r.
    function calculateDeclination(lat, lon) {
        // Bu Ã§ok kaba bir tahmindir, ancak 0'dan iyidir.
        // GerÃ§ek dÃ¼nyada WMM modeli kullanÄ±lÄ±r.
        // TÃ¼rkiye koordinatlarÄ± iÃ§in yaklaÅŸÄ±k bir deÄŸer:
        if (lat > 35 && lat < 45 && lon > 25 && lon < 45) {
            return 6.0; // TÃ¼rkiye iÃ§in ortalama +6 derece (DoÄŸuya sapma)
        }
        return 0;
    }
    let map = null;
    let stream = null;
    const KAABA = [21.4224779, 39.8251832];

    function logDebug(msg) {
        const now = new Date().toLocaleTimeString();
        debugPanel.innerHTML = `[${now}] ${msg}<br>` + debugPanel.innerHTML;
    }

    // Camera Toggle Logic
    cameraToggle.onclick = async () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            cameraFeed.style.display = 'none';
            stream = null;
            logDebug("Kamera kapatÄ±ldÄ±.");
        } else {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                cameraFeed.srcObject = stream;
                cameraFeed.style.display = 'block';
                logDebug("Kamera aÃ§Ä±ldÄ±.");
            } catch (err) {
                logDebug("Kamera hatasÄ±: " + err.message);
                alert("Kamera eriÅŸimi saÄŸlanamadÄ±.");
            }
        }
    };

    function createMarks() {
        const dialRect = dial.getBoundingClientRect();
        let originY = dialRect.height / 2;
        
        // EÄŸer henÃ¼z render edilmediyse fallback kullan
        if (originY === 0) {
            const isMobile = window.innerWidth <= 768;
            originY = isMobile ? 134.25 : 162.5; // 268.5/2 ve 325/2
        }
        
        marksContainer.innerHTML = '';
        
        for (let i = 0; i < 360; i += 5) {
            const mark = document.createElement('div');
            mark.className = i % 30 === 0 ? 'mark cardinal' : 'mark';
            mark.style.transform = `rotate(${i}deg)`;
            mark.style.transformOrigin = `50% ${originY}px`;
            marksContainer.appendChild(mark);

            // Ana yÃ¶n harflerini ekle (K, D, G, B)
            if (i % 90 === 0) {
                const label = document.createElement('div');
                label.className = 'cardinal-label';
                const directions = { 0: 'K', 90: 'D', 180: 'G', 270: 'B' };
                label.textContent = directions[i];
                
                // Harf baÅŸÄ± yer ayarÄ± (Ã§eperden uzaklÄ±k)
                const labelOffset = originY * 0.12; // %12 iÃ§eride dursun
                label.style.top = labelOffset + 'px';
                
                label.style.transform = `translateX(-50%) rotate(${i}deg)`;
                label.style.transformOrigin = `50% ${originY - labelOffset}px`;
                marksContainer.appendChild(label);
            }
        }
    }
    createMarks();
    window.addEventListener('resize', createMarks);

    // Haversine Distance Calculation
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function calculateQibla(lat1, lon1) {
        const phi1 = lat1 * Math.PI / 180;
        const phi2 = KAABA[0] * Math.PI / 180;
        const lam1 = lon1 * Math.PI / 180;
        const lam2 = KAABA[1] * Math.PI / 180;
        const angle = Math.atan2(
            Math.sin(lam2 - lam1),
            Math.cos(phi1) * Math.tan(phi2) - Math.sin(phi1) * Math.cos(lam2 - lam1)
        ) * 180 / Math.PI;
        return (angle + 360) % 360;
    }

    function updateStatus(text, type) {
        // Durum Ã§ubuÄŸu kaldÄ±rÄ±ldÄ±, sadece log tutuyoruz
        logDebug(`Status: ${text} (${type})`);
    }

    function initMap(lat, lon) {
        // Harita kaldÄ±rÄ±ldÄ±
    }

    function initCompass() {
        // Cihaz tespiti: MasaÃ¼stÃ¼ ise hiÃ§ baÅŸlatma
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (!isMobile && window.innerWidth > 1024) {
            logDebug("MasaÃ¼stÃ¼ cihaz tespit edildi, sensÃ¶rler baÅŸlatÄ±lmÄ±yor.");
            return;
        }

        if (!window.isSecureContext) {
            updateStatus("HTTPS gerekli.", "error");
            logDebug("Kritik Hata: HTTPS Ã¼zerinden baÄŸlanÄ±n.");
            return;
        }

        updateStatus("Konum isteniyor...", "");
        logDebug("Geolocation baÅŸlatÄ±ldÄ±.");
        
        navigator.geolocation.getCurrentPosition(position => {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            
            qiblaAngle = calculateQibla(userLat, userLon);
            magneticDeclination = calculateDeclination(userLat, userLon);
            logDebug(`Manyetik Sapma: ${magneticDeclination}Â°`);
            
            const distance = calculateDistance(userLat, userLon, KAABA[0], KAABA[1]);
            
            qiblaVal.textContent = Math.round(qiblaAngle) + 'Â°';
            distanceVal.textContent = Math.round(distance).toLocaleString() + ' km';
            
            qiblaPointer.style.display = 'block';
            updateStatus("SensÃ¶rler baÅŸlatÄ±lÄ±yor...", "active");
            logDebug(`Konum tamam: ${userLat.toFixed(2)},${userLon.toFixed(2)}`);
            
            // Konum alÄ±ndÄ±ktan sonra otomatik sensÃ¶rleri baÅŸlatmayÄ± dene
            setupOrientation(true); 
        }, error => {
            updateStatus("Konum alÄ±namadÄ±. Manuel baÅŸlatÄ±n.", "error");
            logDebug(`Konum HatasÄ±: ${error.message}`);
            permBtn.style.display = 'flex'; // Hata durumunda butonu gÃ¶ster
        }, { 
            enableHighAccuracy: true,
            timeout: 10000
        });
    }

    // Buton tÄ±klama olayÄ±nÄ± en baÅŸta ve her zaman Ã§alÄ±ÅŸacak ÅŸekilde baÄŸla
    permBtn.addEventListener('click', function() {
        logDebug("Butona basÄ±ldÄ±!");
        this.style.background = "rgba(255,255,255,0.3)"; // GÃ¶rsel geri bildirim
        setupOrientation(false);
    });

    function setupOrientation(isAuto = false) {
        logDebug(`setupOrientation(auto=${isAuto}) Ã§aÄŸrÄ±ldÄ±.`);
        // iOS 13+ Ã–zel Ä°zin Ä°steme (Otomatik baÅŸlatÄ±lamaz, kullanÄ±cÄ± etkileÅŸimi ÅŸart)
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            if (isAuto) {
                updateStatus("BaÅŸlatmak iÃ§in dokunun.", "active");
                permBtn.style.display = 'flex'; // iOS'ta butonu gÃ¶ster (mecburiyetten)
                return;
            }
            
            logDebug("iOS Ä°zin Ä°steÄŸi gÃ¶nderiliyor...");
            DeviceOrientationEvent.requestPermission()
                .then(state => {
                    logDebug(`iOS Ä°zin Durumu: ${state}`);
                    if (state === 'granted') {
                        permBtn.style.display = 'none';
                        activateSensors();
                    } else {
                        updateStatus("Ä°zin verilmedi.", "error");
                    }
                })
                .catch(err => {
                    logDebug(`iOS SensÃ¶r HatasÄ±: ${err}`);
                    updateStatus("BaÅŸlatÄ±lamadÄ±.", "error");
                });
        } else {
            // Android / Standart (Otomatik baÅŸlatÄ±labilir)
            logDebug("Standart SensÃ¶rler aktifleÅŸtiriliyor...");
            activateSensors();
        }
    }

    let lastHeading = 0;
    let sensorActive = false;

    function activateSensors() {
        sensorActive = false;
        logDebug("Dinleyiciler baÄŸlanÄ±yor...");

        // Modern AbsoluteOrientationSensor API (Android Chrome iÃ§in en saÄŸlam yol)
        if ('AbsoluteOrientationSensor' in window) {
            try {
                const sensor = new AbsoluteOrientationSensor({ frequency: 60, referenceFrame: 'device' });
                sensor.addEventListener('reading', () => {
                    if (!sensorActive) {
                        sensorActive = true;
                        logDebug("Modern SensÃ¶r: Veri akÄ±ÅŸÄ± baÅŸladÄ±.");
                        updateStatus("Pusula aktif (Modern).", "active");
                    }
                    // Quaternions to Euler (heading)
                    const q = sensor.quaternion;
                    // Standard formula for heading from quaternions
                    let heading = Math.atan2(2 * (q[0] * q[1] + q[2] * q[3]), 1 - 2 * (q[1] * q[1] + q[2] * q[2])) * (180 / Math.PI);
                    
                    // Modern API typically gives values where 0 is North.
                    // Let's ensure it's in 0-360 and matches standard direction
                    heading = (360 - heading) % 360; 
                    processHeading(heading);
                });
                sensor.addEventListener('error', e => {
                    logDebug("Modern SensÃ¶r HatasÄ±: " + e.error.name);
                    fallbackToLegacySensors();
                });
                sensor.start();
                logDebug("Modern SensÃ¶r baÅŸlatÄ±ldÄ±.");
            } catch (err) {
                logDebug("Modern SensÃ¶r baÅŸlatÄ±lamadÄ±: " + err.message);
                fallbackToLegacySensors();
            }
        } else {
            fallbackToLegacySensors();
        }
    }

    function fallbackToLegacySensors() {
        logDebug("Standart dinleyicilere geÃ§iliyor...");
        window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        window.addEventListener('deviceorientation', handleOrientation, true);
        
        // Veri akÄ±ÅŸÄ± kontrolÃ¼
        setTimeout(() => {
            if (!sensorActive) {
                logDebug("KRÄ°TÄ°K: HiÃ§bir sensÃ¶rden veri gelmiyor.");
                updateStatus("SensÃ¶r yanÄ±t vermiyor. LÃ¼tfen sayfayÄ± Chrome veya Safari ile aÃ§Ä±n.", "error");
            }
        }, 5000);
    }

    function handleOrientation(event) {
        if (!sensorActive) {
            sensorActive = true;
            updateStatus("Pusula aktif.", "active");
            logDebug(`Veri geldi! Alpha: ${Math.round(event.alpha)}`);
        }

        let heading = null;
        
        // iOS ve modern cihazlarda manyetik Kuzey
        if (event.webkitCompassHeading !== undefined && event.webkitCompassHeading !== null) {
            heading = event.webkitCompassHeading;
        } else if (event.alpha !== null) {
            // Android'de alpha deÄŸeri saat yÃ¶nÃ¼nÃ¼n tersine artar.
            // Pusula standartÄ± olan saat yÃ¶nÃ¼ne Ã§evirmek iÃ§in 360'tan Ã§Ä±karÄ±yoruz.
            heading = (360 - event.alpha) % 360;
            
            // EÄŸer cihaz 'absolute' deÄŸilse manyetik sapmayÄ± dÃ¼zelt
            if (!event.absolute) {
                heading = (heading + magneticDeclination + 360) % 360;
            }
        }

        if (heading !== null) {
            processHeading(heading);
        }
    }

    let currentVisualHeading = null;

    function processHeading(targetHeading) {
        targetHeading = (targetHeading + 360) % 360;
        
        if (currentVisualHeading === null) {
            currentVisualHeading = targetHeading;
        }

        // Shortest path interpolation (360-0 geÃ§iÅŸ sorunu Ã§Ã¶zÃ¼mÃ¼)
        let diff = targetHeading - currentVisualHeading;
        if (diff > 180) diff -= 360;
        if (diff < -180) diff += 360;
        
        // Ã‡ok kÃ¼Ã§Ã¼k hareketleri yok say (titreme engelleme)
        if (Math.abs(diff) < 0.1) return;

        // YumuÅŸatma faktÃ¶rÃ¼ (0.1 = Ã§ok akÄ±cÄ±, 0.3 = daha hÄ±zlÄ±)
        currentVisualHeading += diff * 0.15;
        currentVisualHeading = (currentVisualHeading + 360) % 360;

        // UI Update
        requestAnimationFrame(() => {
            headingVal.textContent = Math.round(currentVisualHeading) + 'Â°';
            
            // Pusula kadranÄ±nÄ± dÃ¶ndÃ¼r
            dial.style.transform = `rotate(${-currentVisualHeading}deg)`;
            
            // KÄ±ble okunu dÃ¶ndÃ¼r
            const relativeQibla = (qiblaAngle - currentVisualHeading + 360) % 360;
            qiblaPointer.style.transform = `translate(-50%, -50%) rotate(${relativeQibla}deg)`;

            // Hizalanma kontrolÃ¼
            const alignmentDiff = Math.min(Math.abs(relativeQibla), 360 - Math.abs(relativeQibla));
            if (alignmentDiff < 3) {
                if (!wrapper.classList.contains('is-aligned')) {
                    wrapper.classList.add('is-aligned');
                    if (navigator.vibrate) navigator.vibrate([40, 30, 40]);
                }
            } else {
                wrapper.classList.remove('is-aligned');
            }
        });
    }

    initCompass();
</script>
{% endblock %}
